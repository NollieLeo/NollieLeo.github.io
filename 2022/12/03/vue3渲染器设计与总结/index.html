<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>vue3æ¸²æŸ“å™¨è®¾è®¡ä¸æ€»ç»“ | ç¿è€å¸ˆçš„åšå®¢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#00abc0">
    
    
    <meta name="keywords" content="diff,vue">
    <meta name="description" content="å‰ç½®æ¦‚å¿µè™šæ‹Ÿ domvdomï¼Œè™šæ‹Ÿ dom å°±æ˜¯ç”¨æ¥è¡¨ç¤ºçœŸå®çš„ dom å…ƒç´ çš„å±æ€§æˆ–è€…ç‰¹ç‚¹çš„ä¸€å¥—æ•°æ®ç»“æ„ï¼Œå’ŒçœŸå® dom ä¸€æ ·å…·æœ‰æ ‘å½¢ç»“æ„ï¼Œå…·æœ‰è®¸å¤šæ ‘å½¢èŠ‚ç‚¹ vnode å¯ä»¥ç®€è¦çš„è¡¨ç¤º const vnode &#x3D; {   type: &quot;h1&quot;,   children: [     {       type: &quot;h2&quot;,       children: &amp;qu">
<meta property="og:type" content="article">
<meta property="og:title" content="vue3æ¸²æŸ“å™¨è®¾è®¡ä¸æ€»ç»“">
<meta property="og:url" content="https://github.com/NollieLeo/2022/12/03/vue3%E6%B8%B2%E6%9F%93%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="ç¿è€å¸ˆçš„åšå®¢">
<meta property="og:description" content="å‰ç½®æ¦‚å¿µè™šæ‹Ÿ domvdomï¼Œè™šæ‹Ÿ dom å°±æ˜¯ç”¨æ¥è¡¨ç¤ºçœŸå®çš„ dom å…ƒç´ çš„å±æ€§æˆ–è€…ç‰¹ç‚¹çš„ä¸€å¥—æ•°æ®ç»“æ„ï¼Œå’ŒçœŸå® dom ä¸€æ ·å…·æœ‰æ ‘å½¢ç»“æ„ï¼Œå…·æœ‰è®¸å¤šæ ‘å½¢èŠ‚ç‚¹ vnode å¯ä»¥ç®€è¦çš„è¡¨ç¤º const vnode &#x3D; {   type: &quot;h1&quot;,   children: [     {       type: &quot;h2&quot;,       children: &amp;qu">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.com/Users/leo/Library/Application%20Support/marktext/images/2022-12-03-20-32-21-image.png">
<meta property="og:image" content="https://github.com/Users/leo/Library/Application%20Support/marktext/images/2022-12-05-00-50-37-image.png">
<meta property="og:image" content="https://github.com/Users/leo/Library/Application%20Support/marktext/images/2022-12-05-00-53-03-image.png">
<meta property="og:image" content="file:///Users/leo/Library/Application%20Support/marktext/images/2022-12-09-22-45-02-image.png">
<meta property="article:published_time" content="2022-12-03T11:39:37.000Z">
<meta property="article:modified_time" content="2022-12-13T01:41:56.270Z">
<meta property="article:author" content="Mr.Weng">
<meta property="article:tag" content="diff">
<meta property="article:tag" content="vue">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/Users/leo/Library/Application%20Support/marktext/images/2022-12-03-20-32-21-image.png">
    
        <link rel="alternate" type="application/atom+xml" title="ç¿è€å¸ˆçš„åšå®¢" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Mr.Weng</h5>
          <a href="mailto:736653759@qq.com" title="736653759@qq.com" class="mail">736653759@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                ä¸»é¡µ
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/nollieleo" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">vue3æ¸²æŸ“å™¨è®¾è®¡ä¸æ€»ç»“</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="è¾“å…¥æ„Ÿå…´è¶£çš„å…³é”®å­—">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">vue3æ¸²æŸ“å™¨è®¾è®¡ä¸æ€»ç»“</h1>
        <h5 class="subtitle">
            
                <time datetime="2022-12-03T11:39:37.000Z" itemprop="datePublished" class="page-time">
  2022-12-03
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#å‰ç½®æ¦‚å¿µ"><span class="post-toc-number">1.</span> <span class="post-toc-text">å‰ç½®æ¦‚å¿µ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#è™šæ‹Ÿ-dom"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">è™šæ‹Ÿ dom</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#æ¸²æŸ“å™¨"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">æ¸²æŸ“å™¨</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#æŒ‚è½½"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">æŒ‚è½½</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#å®ç°æ¸²æŸ“å™¨"><span class="post-toc-number">2.</span> <span class="post-toc-text">å®ç°æ¸²æŸ“å™¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ç®€å•çš„æ¸²æŸ“åŸç†"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">ç®€å•çš„æ¸²æŸ“åŸç†</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ç»“åˆ-reactivity"><span class="post-toc-number">2.1.1.</span> <span class="post-toc-text">ç»“åˆ reactivity</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#è‡ªå®šä¹‰æ¸²æŸ“å™¨"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">è‡ªå®šä¹‰æ¸²æŸ“å™¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å·¥å‚å‡½æ•°"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">å·¥å‚å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#åŠ å…¥æ›´æ–°çš„æ¦‚å¿µ"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">åŠ å…¥æ›´æ–°çš„æ¦‚å¿µ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#patch-ç®€å•å®ç°"><span class="post-toc-number">2.2.2.1.</span> <span class="post-toc-text">patch ç®€å•å®ç°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#å®ç°-mountElement-æŒ‚è½½"><span class="post-toc-number">2.2.2.2.</span> <span class="post-toc-text">å®ç° mountElement æŒ‚è½½</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#é…ç½®é¡¹å½¢å¼æŠ½ç¦»"><span class="post-toc-number">2.2.3.</span> <span class="post-toc-text">é…ç½®é¡¹å½¢å¼æŠ½ç¦»</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#æŒ‚è½½å’Œæ›´æ–°"><span class="post-toc-number">3.</span> <span class="post-toc-text">æŒ‚è½½å’Œæ›´æ–°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#å­èŠ‚ç‚¹æŒ‚è½½"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">å­èŠ‚ç‚¹æŒ‚è½½</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#æŒ‚è½½èŠ‚ç‚¹çš„å±æ€§"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">æŒ‚è½½èŠ‚ç‚¹çš„å±æ€§</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ğŸŒŸHTML-attribute-å’Œ-DOM-properties-åŒºåˆ«"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">ğŸŒŸHTML attribute å’Œ DOM properties åŒºåˆ«</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#æ­£ç¡®çš„è®¾ç½®èŠ‚ç‚¹çš„å±æ€§"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">æ­£ç¡®çš„è®¾ç½®èŠ‚ç‚¹çš„å±æ€§</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#å¸ƒå°”ç±»å‹å±æ€§å¤„ç†"><span class="post-toc-number">3.2.2.1.</span> <span class="post-toc-text">å¸ƒå°”ç±»å‹å±æ€§å¤„ç†</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#åªè¯»ç±»å‹å±æ€§å¤„ç†"><span class="post-toc-number">3.2.2.2.</span> <span class="post-toc-text">åªè¯»ç±»å‹å±æ€§å¤„ç†</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#æå–å¹³å°æ— å…³ä»£ç "><span class="post-toc-number">3.2.2.3.</span> <span class="post-toc-text">æå–å¹³å°æ— å…³ä»£ç </span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#class-å’Œ-style-çš„å¤„ç†"><span class="post-toc-number">3.2.3.</span> <span class="post-toc-text">class å’Œ style çš„å¤„ç†</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#å®ç°-normalizeClass"><span class="post-toc-number">3.2.3.1.</span> <span class="post-toc-text">å®ç° normalizeClass</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#è®¾ç½®-class"><span class="post-toc-number">3.2.3.2.</span> <span class="post-toc-text">è®¾ç½® class</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#å¸è½½æ“ä½œ"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">å¸è½½æ“ä½œ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å»ºç«‹-dom-ä¸-vnode-è”ç³»"><span class="post-toc-number">3.3.1.</span> <span class="post-toc-text">å»ºç«‹ dom ä¸ vnode è”ç³»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#æ”¹é€ -render-å‡½æ•°"><span class="post-toc-number">3.3.2.</span> <span class="post-toc-text">æ”¹é€  render å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å°è£…-unmount"><span class="post-toc-number">3.3.3.</span> <span class="post-toc-text">å°è£… unmount</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#åŒºåˆ†-vnode-ç±»å‹"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">åŒºåˆ† vnode ç±»å‹</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#äº‹ä»¶å¤„ç†"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">äº‹ä»¶å¤„ç†</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ç»‘å®šäº‹ä»¶å’Œæ›´æ–°"><span class="post-toc-number">3.5.1.</span> <span class="post-toc-text">ç»‘å®šäº‹ä»¶å’Œæ›´æ–°</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#æ›´æ–°å±æ€§ä»¥åŠå­èŠ‚ç‚¹"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">æ›´æ–°å±æ€§ä»¥åŠå­èŠ‚ç‚¹</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å®ç°-props-å˜åŒ–æ›´æ–°"><span class="post-toc-number">3.6.1.</span> <span class="post-toc-text">å®ç° props å˜åŒ–æ›´æ–°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#é¡ºæ‰‹æ”¹é€ -patchProps-å‡½æ•°"><span class="post-toc-number">3.6.1.1.</span> <span class="post-toc-text">é¡ºæ‰‹æ”¹é€  patchProps å‡½æ•°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#æ“ä½œ-class-æ›´æ–°"><span class="post-toc-number">3.6.1.1.1.</span> <span class="post-toc-text">æ“ä½œ class æ›´æ–°</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#æ“ä½œæ ·å¼çš„æ›´æ–°"><span class="post-toc-number">3.6.1.1.2.</span> <span class="post-toc-text">æ“ä½œæ ·å¼çš„æ›´æ–°</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#æ“ä½œäº‹ä»¶çš„æ›´æ–°"><span class="post-toc-number">3.6.1.1.3.</span> <span class="post-toc-text">æ“ä½œäº‹ä»¶çš„æ›´æ–°</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#æ“ä½œå±æ€§çš„æ›´æ–°"><span class="post-toc-number">3.6.1.1.4.</span> <span class="post-toc-text">æ“ä½œå±æ€§çš„æ›´æ–°</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#æ›´æ–°-children-èŠ‚ç‚¹"><span class="post-toc-number">3.6.2.</span> <span class="post-toc-text">æ›´æ–° children èŠ‚ç‚¹</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-æ–°å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹"><span class="post-toc-number">3.6.2.1.</span> <span class="post-toc-text">1. æ–°å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-æ–°å­èŠ‚ç‚¹æ˜¯ä¸€ç»„"><span class="post-toc-number">3.6.2.2.</span> <span class="post-toc-text">2. æ–°å­èŠ‚ç‚¹æ˜¯ä¸€ç»„</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-æ–°å­èŠ‚ç‚¹å•¥ä¹Ÿæ²¡æœ‰"><span class="post-toc-number">3.6.2.3.</span> <span class="post-toc-text">3. æ–°å­èŠ‚ç‚¹å•¥ä¹Ÿæ²¡æœ‰</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹"><span class="post-toc-number">3.7.</span> <span class="post-toc-text">ç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#æ–‡æœ¬èŠ‚ç‚¹å’Œæ³¨é‡ŠèŠ‚ç‚¹å¤„ç†"><span class="post-toc-number">3.7.1.</span> <span class="post-toc-text">æ–‡æœ¬èŠ‚ç‚¹å’Œæ³¨é‡ŠèŠ‚ç‚¹å¤„ç†</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Fragment"><span class="post-toc-number">3.7.2.</span> <span class="post-toc-text">Fragment</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#diff-ç®—æ³•"><span class="post-toc-number">3.8.</span> <span class="post-toc-text">diff ç®—æ³•</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ç®€å•çš„-diff-ç®—æ³•"><span class="post-toc-number">3.8.1.</span> <span class="post-toc-text">ç®€å•çš„ diff ç®—æ³•</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#åŒç«¯-diff-ç®—æ³•"><span class="post-toc-number">3.8.2.</span> <span class="post-toc-text">åŒç«¯ diff ç®—æ³•</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å¿«é€Ÿ-diff-ç®—æ³•"><span class="post-toc-number">3.8.3.</span> <span class="post-toc-text">å¿«é€Ÿ diff ç®—æ³•</span></a></li></ol></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-vue3æ¸²æŸ“å™¨è®¾è®¡ä¸æ€»ç»“"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">vue3æ¸²æŸ“å™¨è®¾è®¡ä¸æ€»ç»“</h1>
        <div class="post-meta">
            <time class="post-time" title="2022-12-03 19:39:37" datetime="2022-12-03T11:39:37.000Z"  itemprop="datePublished">2022-12-03</time>

            


            
<span id="busuanzi_container_page_pv" title="æ–‡ç« æ€»é˜…è¯»é‡" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="å‰ç½®æ¦‚å¿µ"><a href="#å‰ç½®æ¦‚å¿µ" class="headerlink" title="å‰ç½®æ¦‚å¿µ"></a>å‰ç½®æ¦‚å¿µ</h1><h2 id="è™šæ‹Ÿ-dom"><a href="#è™šæ‹Ÿ-dom" class="headerlink" title="è™šæ‹Ÿ dom"></a>è™šæ‹Ÿ dom</h2><p>vdomï¼Œè™šæ‹Ÿ dom å°±æ˜¯ç”¨æ¥è¡¨ç¤ºçœŸå®çš„ dom å…ƒç´ çš„å±æ€§æˆ–è€…ç‰¹ç‚¹çš„ä¸€å¥—æ•°æ®ç»“æ„ï¼Œå’ŒçœŸå® dom ä¸€æ ·å…·æœ‰æ ‘å½¢ç»“æ„ï¼Œå…·æœ‰è®¸å¤šæ ‘å½¢èŠ‚ç‚¹ vnode</p>
<p>å¯ä»¥ç®€è¦çš„è¡¨ç¤º</p>
<pre><code class="js">const vnode = {
  type: &quot;h1&quot;,
  children: [
    {
      type: &quot;h2&quot;,
      children: &quot;æˆ‘æ˜¯h2&quot;,
    },
  ],
};</code></pre>
<h2 id="æ¸²æŸ“å™¨"><a href="#æ¸²æŸ“å™¨" class="headerlink" title="æ¸²æŸ“å™¨"></a>æ¸²æŸ“å™¨</h2><p>æ¸²æŸ“å™¨çš„åŸºæœ¬ä½œç”¨å°±æ˜¯æŠŠè™šæ‹Ÿ dom æ¸²æŸ“ä¸ºå¹³å°ä¸Šé¢çš„çœŸå® å…ƒç´ ï¼Œæµè§ˆå™¨ä¸Šå°±æ˜¯çœŸå®çš„ dom å…ƒç´ ã€‚</p>
<h2 id="æŒ‚è½½"><a href="#æŒ‚è½½" class="headerlink" title="æŒ‚è½½"></a>æŒ‚è½½</h2><p>mountedï¼Œæ„æ€å°±æ˜¯æ¸²æŸ“å™¨è¯»å–è§£æ vnode/vdom å±æ€§ä¹‹åï¼Œä½¿ç”¨çœŸå®çš„ dom å½¢å¼å¹¶ä¸”è¡¨ç°åœ¨é¡µé¢ä¸Š/æˆ–è€…æ˜¯å…·ä½“çš„é¡µé¢æŸä¸ªä½ç½®ä¸Š</p>
<h1 id="å®ç°æ¸²æŸ“å™¨"><a href="#å®ç°æ¸²æŸ“å™¨" class="headerlink" title="å®ç°æ¸²æŸ“å™¨"></a>å®ç°æ¸²æŸ“å™¨</h1><h2 id="ç®€å•çš„æ¸²æŸ“åŸç†"><a href="#ç®€å•çš„æ¸²æŸ“åŸç†" class="headerlink" title="ç®€å•çš„æ¸²æŸ“åŸç†"></a>ç®€å•çš„æ¸²æŸ“åŸç†</h2><p><strong>renderer</strong>: æ¸²æŸ“å‡½æ•°</p>
<p>å°±æ˜¯é€šè¿‡ innerHTML çš„å½¢å¼å°†ç¬¬ä¸€ä¸ªå‚æ•° domString æ’å…¥åˆ°å¯¹åº”å®¹å™¨å½“ä¸­</p>
<pre><code class="js">function renderer(domString, container) {
  container.innerHTML = domString;
}

renderer(&quot;&lt;h1&gt;vue3 renderer&lt;/h1&gt;&quot;, document.getElementById(&quot;app&quot;));</code></pre>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/Users/leo/Library/Application%20Support/marktext/images/2022-12-03-20-32-21-image.png" alt title>
                </div>
                <div class="image-caption"></div>
            </figure>

<h3 id="ç»“åˆ-reactivity"><a href="#ç»“åˆ-reactivity" class="headerlink" title="ç»“åˆ reactivity"></a>ç»“åˆ reactivity</h3><p>å¼•å…¥ vue3 çš„ reactivity åŒ…ï¼Œä»–ä¼šåœ¨å…¨å±€æš´éœ²ä¸€ä¸ª VueReactivity å˜é‡</p>
<p><a href="https://cdn.jsdelivr.net/npm/@vue/reactivity@3.2.45/dist/reactivity.global.min.js" target="_blank" rel="noopener">cdn åœ°å€</a></p>
<pre><code class="html">&lt;script src=&quot;https://cdn.jsdelivr.net/npm/@vue/reactivity@3.2.45/dist/reactivity.global.min.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;module&quot;&gt;
  import { renderer } from &quot;./render.js&quot;;

  const { effect, ref } = VueReactivity;

  const count = ref(1);

  effect(() =&gt; {
    renderer(
      `&lt;h1&gt;vue3 renderer times: ${count.value}&lt;/h1&gt;`,
      document.getElementById(&quot;app&quot;)
    );
  });

  setTimeout(() =&gt; {
    count.value++;
  }, 2000);
&lt;/script&gt;</code></pre>
<p>é€šè¿‡å¼•å…¥ vue3 çš„ reactivityï¼Œæˆ‘ä»¬èƒ½å¤Ÿå®ç°ä¸€ä¸ªåŠ¨æ€æ¸²æŸ“çš„åŸºæœ¬é€»è¾‘</p>
<h2 id="è‡ªå®šä¹‰æ¸²æŸ“å™¨"><a href="#è‡ªå®šä¹‰æ¸²æŸ“å™¨" class="headerlink" title="è‡ªå®šä¹‰æ¸²æŸ“å™¨"></a>è‡ªå®šä¹‰æ¸²æŸ“å™¨</h2><blockquote>
<p>vue3 ä¸­çš„æ¸²æŸ“å™¨ï¼Œæ˜¯è®¾è®¡ä¸ºé€šç”¨å¯é…ç½®çš„ï¼Œå³å¯å®ç°æ¸²æŸ“åˆ°ä»»æ„ç›®æ ‡çš„å¹³å°ä¸Šï¼Œæˆ‘ä»¬ç›®å‰è¯´çš„ç›®æ ‡å¹³å°ï¼Œå…ˆæŒ‡å®šæµè§ˆå™¨ï¼›åç»­å¯ä»¥å°†ä¸€äº›å¯æŠ½è±¡çš„ API æŠ½ç¦»ï¼Œä½¿å¾—æ¸²æŸ“å™¨çš„æ ¸å¿ƒä¸ä¾èµ–ä¸æµè§ˆå™¨çš„ api</p>
<p>è¿™ä¹Ÿå°±æ˜¯ vue çš„æ ¸å¿ƒä¹‹ä¸€ï¼Œå°†ç›¸å…³æµè§ˆå™¨çš„ api å°è£…åˆ°äº†<strong>runtime-dom</strong>çš„ä¸€ä¸ªåŒ…ï¼Œæä¾›äº†å¾ˆå¤šé’ˆå¯¹æµè§ˆå™¨çš„ dom apiï¼Œå±æ€§ä»¥åŠäº‹ä»¶å¤„ç†</p>
</blockquote>
<h3 id="å·¥å‚å‡½æ•°"><a href="#å·¥å‚å‡½æ•°" class="headerlink" title="å·¥å‚å‡½æ•°"></a>å·¥å‚å‡½æ•°</h3><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª createRenderer çš„å·¥å‚å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ¸²æŸ“å™¨, å¹¶ä¸”æŠ›å‡ºè®¸å¤šçš„æ–¹æ³•</p>
<pre><code class="js">/** åˆ›å»ºä¸€ä¸ªæ¸²æŸ“å™¨ */
function createRenderer() {
  const render = (vnode, container) =&gt; {
    // ...
  };

  // åç»­ä¼šæœ‰å„ç§æ–¹æ³•

  return { render };
}</code></pre>
<p>ä¹‹åè¿›è¡Œç›¸å…³çš„æ¸²æŸ“è°ƒç”¨</p>
<pre><code class="js">const renderer = createRenderer();
renderer.render(vNode, document.getElementById(&quot;app&quot;));</code></pre>
<h3 id="åŠ å…¥æ›´æ–°çš„æ¦‚å¿µ"><a href="#åŠ å…¥æ›´æ–°çš„æ¦‚å¿µ" class="headerlink" title="åŠ å…¥æ›´æ–°çš„æ¦‚å¿µ"></a>åŠ å…¥æ›´æ–°çš„æ¦‚å¿µ</h3><p>ç¬¬ä¸€æ¬¡è°ƒç”¨</p>
<pre><code class="js">renderer.render(vNode, document.getElementById(&quot;app&quot;));</code></pre>
<p>ç¬¬äºŒæ¬¡è°ƒç”¨æ¸²æŸ“çš„æ—¶å€™è¿˜æ˜¯åœ¨åŒä¸€ä¸ª container ä¸Šè°ƒç”¨çš„</p>
<pre><code class="js">renderer.render(newVNode, document.getElementById(&quot;app&quot;));</code></pre>
<p>ç”±äºé¦–æ¬¡çš„æ¸²æŸ“å·²ç»å°†å¯¹åº”çš„ dom æ¸²æŸ“åˆ°äº† container å†…éƒ¨äº†ï¼Œæ‰€ä»¥å†æ¬¡è°ƒç”¨ render å‡½æ•°çš„æ—¶å€™ï¼Œæ¸²æŸ“ä¸€ä¸ªæ–°çš„è™šæ‹Ÿ domï¼Œå°±å•å•æ˜¯åšä¸€ä¸ªç®€å•çš„æŒ‚è½½çš„åŠ¨ä½œäº†ï¼Œè€Œæ˜¯è¦è¿›è¡Œæ›´æ–°å¯¹æ¯”ï¼Œæ‰¾å‡ºå˜åŠ¨çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«åš - <strong>æ‰“è¡¥ä¸ï¼ˆæ›´æ–°ï¼‰</strong></p>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥ç›¸å…³çš„æ”¹é€ ä¸€ä¸‹ä»£ç ï¼š</p>
<p>å¼•å…¥ä¸€ä¸ªæ›´æ–°çš„æ¦‚å¿µå¤„ç†çš„é€»è¾‘</p>
<pre><code class="js">/** åˆ›å»ºä¸€ä¸ªæ¸²æŸ“å™¨ */
function createRenderer() {
  const render = (vnode, container) =&gt; {
    if (vnode) {
      // æ–°çš„nodeå­˜åœ¨çš„æƒ…å†µï¼Œå°†å…¶æ—§çš„vnodeä¸€èµ·ä¼ é€’ç»™patchå‡½æ•°è¿›è¡Œè¡¥ä¸çš„æ›´æ–°
      patch(container._vnode, vnode, container);
    } else {
      if (container._vnode) {
        // æ—§çš„vnodeå­˜åœ¨ï¼Œæ–°çš„vnodeä¸å­˜åœ¨çš„æƒ…å†µï¼Œè¯´æ˜æ˜¯ä¸€ä¸ª unmountï¼ˆå¸è½½ï¼‰çš„æ“ä½œ
        // è¿™é‡Œåªéœ€è¦å°†containerå†…domæ¸…ç©ºå°±å¯ä»¥, ç›®å‰æš‚æ—¶è¿™æ ·æ¸…ç©º
        container.innerHTML = &quot;&quot;;
      }
    }
    // æ¯ä¸€æ¬¡éƒ½éœ€è¦ä¿å­˜ä¸Šä¸€æ¬¡çš„vnodeï¼Œå­˜å‚¨åœ¨containerä¸‹
    container._vnode = vnode; // æš‚æ—¶ä½¿ç”¨è¿™æ®µä»£ç æ¸…ç©ºï¼Œåç»­ä¼šå®Œå–„
  };

  return { render };
}</code></pre>
<h4 id="patch-ç®€å•å®ç°"><a href="#patch-ç®€å•å®ç°" class="headerlink" title="patch ç®€å•å®ç°"></a>patch ç®€å•å®ç°</h4><p>å…¶ä¸­ patch çš„å‡½æ•°ï¼Œæ˜¯æœ€æœ€é‡è¦çš„ä¸€ä¸ªæ¸²æŸ“å™¨çš„æ ¸å¿ƒï¼Œä¸»è¦æ˜¯åšåˆå§‹åŒ–å’Œç›¸å…³çš„ diff æ“ä½œ</p>
<p>ç›®å‰è¿›è¡Œç®€å•å®ç°ï¼Œåç»­ç€é‡è¯´</p>
<pre><code class="js">/** æ›´æ–°å¯¹æ¯” */
function patch(n1, n2, container) {
  // å¦‚æœä¸å­˜åœ¨
  if (!n1) {
    mountElement(n2, container);
  } else {
    // n1å­˜åœ¨çš„æƒ…å†µä¸‹é¢ï¼Œæˆ‘ä»¬è¿›è¡Œæ›´æ–°ï¼ˆæ‰“è¡¥ä¸ï¼‰
  }
}</code></pre>
<ul>
<li><p>n1: è€çš„ vnode</p>
</li>
<li><p>n2: æ–°çš„ vnode</p>
</li>
<li><p>container: å®¹å™¨</p>
</li>
</ul>
<p>å¦‚æœä¸å­˜åœ¨æ—§çš„ vnode çš„æƒ…å†µä¸‹ï¼Œè¯´æ˜åªæ˜¯éœ€è¦è¿›è¡Œå…ƒç´ çš„æŒ‚è½½å³å¯</p>
<h4 id="å®ç°-mountElement-æŒ‚è½½"><a href="#å®ç°-mountElement-æŒ‚è½½" class="headerlink" title="å®ç° mountElement æŒ‚è½½"></a>å®ç° mountElement æŒ‚è½½</h4><pre><code class="js">/** æŒ‚è½½ */
function mountElement(vnode, container) {
  // åˆ›å»ºdomå…ƒç´ 
  const el = document.createElement(vnode.type);
  //å¤„ç†å­èŠ‚ç‚¹, å¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === &quot;string&quot;) {
    // åªéœ€è¦è®¾ç½®å…ƒç´ çš„textContentçš„å±æ€§å³å¯
    el.textContent = vnode.children;
  }
  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  container.appendChild(el);
}</code></pre>
<p>é€šè¿‡ vnode çš„ type æ ‡ç­¾åç§°åˆ›å»ºä¸€ä¸ªæ–°çš„ dom å…ƒç´ ï¼Œæ¥ç€å¤„ç† childrenï¼Œå¦‚æœæ˜¯å­—ç¬¦ä¸²çš„ç±»å‹ï¼Œè¯´æ˜æ˜¯æ–‡æœ¬çš„ child èŠ‚ç‚¹ï¼Œç›´æ¥è®¾ç½® textContent å°±å¯ä»¥äº†ï¼Œä¹‹å appendChild æ’å…¥å®¹å™¨å½“ä¸­</p>
<h3 id="é…ç½®é¡¹å½¢å¼æŠ½ç¦»"><a href="#é…ç½®é¡¹å½¢å¼æŠ½ç¦»" class="headerlink" title="é…ç½®é¡¹å½¢å¼æŠ½ç¦»"></a>é…ç½®é¡¹å½¢å¼æŠ½ç¦»</h3><p>å› ä¸ºæˆ‘ä»¬è¦è®¾è®¡ä¸€ä¸ªç›¸å½“äºæ˜¯ä¸ä¾èµ–äºå¹³å°çš„ä¸€ä¸ªé€šç”¨æ¸²æŸ“å™¨ï¼Œæ‰€ä»¥ï¼Œéœ€è¦å°†ä¸Šè¿°æ‰€ç”¨åˆ°çš„æ‰€æœ‰ä¾èµ–äºæµè§ˆå™¨çš„ api éƒ½ç»™æŠ½ç¦»å‡ºæ¥ï¼Œå®ç°ç‹¬ç«‹å°è£…çš„é…ç½®é¡¹</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æŠ½ç¦»<strong>mountElement</strong>å‡½æ•°ä½¿ç”¨åˆ°çš„ä¸€äº›æµè§ˆå™¨æ–¹æ³•</p>
<pre><code class="js">/** æµè§ˆå™¨ç«¯çš„ç›¸å…³api */
const BROWSER_APIS = {
  // ç”¨äºåˆ›å»ºå…ƒç´ 
  createElement(tag) {
    return document.createElement(tag);
  },

  /** ç”¨äºè®¾ç½®å…ƒç´ çš„æ–‡æœ¬èŠ‚ç‚¹ */
  setElementText(el, text) {
    el.textContent = text;
  },

  /** ç»™ç‰¹å®šçš„parentä¸‹æ·»åŠ æŒ‡å®šçš„å…ƒç´  */
  insert(el, parent, anchor = null) {
    parent.insertBefore(el, anchor);
  },
};

export default BROWSER_APIS;</code></pre>
<p>ä¹‹åæˆ‘ä»¬æ”¹é€ <strong>createRenderer</strong>å‡½æ•°</p>
<p>å°†ç›¸å…³çš„ api ä»¥ options çš„å½¢å¼ä¼ å…¥</p>
<pre><code class="js">/** åˆ›å»ºä¸€ä¸ªæ¸²æŸ“å™¨ */
function createRenderer(options) {
  const { createElement, insert, setElementText } = options;

  /** æŒ‚è½½ */
  function mountElement(vnode, container) {
    // ...
  }

  /** æ›´æ–°å¯¹æ¯” */
  function patch(n1, n2, container) {
    // ...
  }

  /** æ¸²æŸ“æ–¹æ³• */
  const render = (vnode, container) =&gt; {
    // ...
  };

  return { render };
}

export { createRenderer };</code></pre>
<p>ä¹‹åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¼ é€’è¿›æ¥çš„å¯é…ç½®çš„ apis å»å®ç°ç›¸å…³çš„æ¸²æŸ“å™¨æ“ä½œ</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹é€ <strong>mountElement</strong>å¹¶ä¸”ä½¿ç”¨åˆ°ç›¸å…³çš„ apis</p>
<pre><code class="js">/** æŒ‚è½½ */
function mountElement(vnode, container) {
  // åˆ›å»ºdomå…ƒç´ 
  const el = createElement(vnode.type); // â•
  //å¤„ç†å­èŠ‚ç‚¹, å¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === &quot;string&quot;) {
    // åªéœ€è¦è®¾ç½®å…ƒç´ çš„textContentçš„å±æ€§å³å¯
    setElementText(e, vnode.children); // â•
  }
  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container); // â•
}</code></pre>
<blockquote>
<p>é€šè¿‡äº†ä»¥ä¸Šé…ç½®ä¹‹åï¼Œæ¸²æŸ“å™¨å°†ä¸ä»…ä»…å¯ä»¥åœ¨æµè§ˆå™¨ç«¯è¿›è¡Œä½¿ç”¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®ä¸åŒçš„å¹³å°ï¼Œä¼ å…¥ä¸åŒçš„è‡ªå®šä¹‰çš„ç›¸å…³ api å‚æ•°</p>
</blockquote>
<h1 id="æŒ‚è½½å’Œæ›´æ–°"><a href="#æŒ‚è½½å’Œæ›´æ–°" class="headerlink" title="æŒ‚è½½å’Œæ›´æ–°"></a>æŒ‚è½½å’Œæ›´æ–°</h1><h2 id="å­èŠ‚ç‚¹æŒ‚è½½"><a href="#å­èŠ‚ç‚¹æŒ‚è½½" class="headerlink" title="å­èŠ‚ç‚¹æŒ‚è½½"></a>å­èŠ‚ç‚¹æŒ‚è½½</h2><p>ä¸Šè¿°æˆ‘ä»¬åªè€ƒè™‘åˆ°äº†ä¸€ä¸ª vnode çš„ children ä¸º string çš„æƒ…å†µä¸‹çš„æŒ‚è½½ï¼Œä½¿ç”¨ <strong>setElementText</strong> å¯¹å…ƒç´ è¿›è¡ŒæŒ‚è½½ï¼Œä½†æ˜¯ children å¯èƒ½å­˜åœ¨å¤šä¸ª vnode é string ç±»å‹çš„æƒ…å†µ</p>
<p><strong>ä¾‹å¦‚</strong>ï¼šä»¥ä¸‹çš„ vnodeï¼Œæœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹</p>
<pre><code class="js">const vNode = {
  type: &quot;div&quot;,
  children: [
    {
      type: &quot;p&quot;,
      children: &quot;111&quot;,
    },
    {
      type: &quot;p&quot;,
      children: &quot;222&quot;,
    },
  ],
};</code></pre>
<p>å› æ­¤éœ€è¦æ”¹é€ æŒ‚è½½å‡½æ•°ï¼Œä½¿å…¶å…·æœ‰æŒ‚è½½å­èŠ‚ç‚¹çš„èƒ½åŠ›ã€‚è¿™é‡ŒåŠ å…¥ä¸€å±‚ children èŠ‚ç‚¹çš„åˆ¤æ–­</p>
<pre><code class="js">/** æŒ‚è½½å‡½æ•°è°ƒç”¨ */
function mountElement(vnode, container) {
  // åˆ›å»ºdomå…ƒç´ 
  const el = createElement(vnode.type);
  //å¤„ç†å­èŠ‚ç‚¹, å¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === &quot;string&quot;) {
    // åªéœ€è¦è®¾ç½®å…ƒç´ çš„textContentçš„å±æ€§å³å¯
    setElementText(el, vnode.children);
  } else if (Array.isArray(vnode.children)) {
    // â•
    // å¦‚æœchildrenæ˜¯æ•°ç»„ï¼Œåˆ™ä¾¿éå†æ¯ä¸€ä¸ªå­—èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨patchçš„æ–¹æ³•
    vnode.children.forEach((child) =&gt; {
      patch(null, child, el);
    });
  }
  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container);
}</code></pre>
<h2 id="æŒ‚è½½èŠ‚ç‚¹çš„å±æ€§"><a href="#æŒ‚è½½èŠ‚ç‚¹çš„å±æ€§" class="headerlink" title="æŒ‚è½½èŠ‚ç‚¹çš„å±æ€§"></a>æŒ‚è½½èŠ‚ç‚¹çš„å±æ€§</h2><p>ä¸€ä¸ªå…ƒç´ å¯ä»¥ç”¨å¤šä¸ªå±æ€§æ¥è¿›è¡Œæè¿°ï¼Œå½“ç„¶æ˜ å°„åˆ°è™šæ‹Ÿ dom ä¸Šçš„è¯ï¼Œç”¨ä¸€ä¸ª props çš„å±æ€§è¿›è¡Œè¡¨ç¤ºã€‚</p>
<pre><code class="js">const vNode = {
  type: &quot;div&quot;,
  props: {
    id: &quot;foo&quot;,
  },
  children: [
    {
      type: &quot;p&quot;,
      children: &quot;111&quot;,
    },
    {
      type: &quot;p&quot;,
      children: &quot;222&quot;,
    },
  ],
};</code></pre>
<p>å› æ­¤æˆ‘ä»¬åœ¨æŒ‚è½½å…ƒç´ çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦å°†è¿™äº›å±æ€§å€¼æ¸²æŸ“åˆ°å¯¹åº”çš„å…ƒç´ ä¸Šé¢</p>
<p>æ”¹é€ æŒ‚è½½å‡½æ•°</p>
<pre><code class="js">/** æŒ‚è½½å‡½æ•°è°ƒç”¨ */
function mountElement(vnode, container) {
  // åˆ›å»ºdomå…ƒç´ 
  const el = createElement(vnode.type);
  //å¤„ç†å­èŠ‚ç‚¹, å¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === &quot;string&quot;) {
    // åªéœ€è¦è®¾ç½®å…ƒç´ çš„textContentçš„å±æ€§å³å¯
    setElementText(el, vnode.children);
  } else if (Array.isArray(vnode.children)) {
    // å¦‚æœchildrenæ˜¯æ•°ç»„ï¼Œåˆ™ä¾¿éå†æ¯ä¸€ä¸ªå­—èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨patchçš„æ–¹æ³•
    vnode.children.forEach((child) =&gt; {
      patch(null, child, el);
    });
  }

  // å¤„ç†props, å­˜åœ¨çš„æƒ…å†µä¸‹è¿›è¡Œå¤„ç†
  if (vnode.props) {
    // â•
    // éå†
    for (const key in vnode.props) {
      if (key in el) {
        const prop = vnode.props[key];
        // è°ƒç”¨setAttributeå°†å±æ€§è®¾ç½®åˆ°å…ƒç´ ä¸Š
        el.setAttribute(key, prop); // ğŸŒŸ
      }
    }
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container);
}</code></pre>
<p>åœ¨æ ‡è®°â€œğŸŒŸâ€œçš„åœ°æ–¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>el[key] = vnode.props[key]</code>ï¼Œä½†æ˜¯ç”±äºè¿™éƒ½æ˜¯å±äºç›´æ¥æ“ä½œ dom å¯¹è±¡çš„è¡Œä¸ºï¼Œæ‰€ä»¥éƒ½ä¼šå­˜åœ¨ç¼ºé™·ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æƒ³åŠæ³•å¦‚ä½•çš„æ­£ç¡®è®¾ç½®å…ƒç´ çš„å±æ€§</p>
<h3 id="ğŸŒŸHTML-attribute-å’Œ-DOM-properties-åŒºåˆ«"><a href="#ğŸŒŸHTML-attribute-å’Œ-DOM-properties-åŒºåˆ«" class="headerlink" title="ğŸŒŸHTML attribute å’Œ DOM properties åŒºåˆ«"></a>ğŸŒŸHTML attribute å’Œ DOM properties åŒºåˆ«</h3><p>HTML attribute æŒ‡çš„å°±æ˜¯å®šä¹‰åœ¨ HMTL æ ‡ç­¾ä¸Šçš„å±æ€§</p>
<pre><code class="html">&lt;input id=&quot;my-input&quot; type=&quot;text&quot; value=&quot;foo&quot; /&gt;</code></pre>
<p>document æ–‡æ¡£è§£æä¹‹åï¼Œä¼šç”Ÿæˆä¸€ä¸ªä¸ä¹‹ç›¸ç¬¦çš„ dom å…ƒç´ å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸Šé¢åŒ…å«äº†å¾ˆå¤šçš„å±æ€§</p>
{% image /Users/leo/Library/Application%20Support/marktext/images/2022-12-05-00-37-36-image.png '' '' %}

<p>è¿™äº›å°±æ˜¯æ‰€è°“çš„ dom propertyã€‚</p>
<p><strong>ä¸¤è€…çš„åŒºåˆ†</strong>å¤§è‡´å¦‚ä¸‹</p>
<ol>
<li><p>å¾ˆå¤šçš„ HTMl attribute åœ¨ DOM å¯¹è±¡ä¸Šé¢éƒ½æœ‰ä¸ä¹‹åŒåçš„ DOM propertiesï¼Œä½†æ˜¯å‘½åè§„åˆ™å´ä¸ä¸€æ ·</p>
<p><strong>ä¾‹å¦‚</strong>ï¼šHTML attribute çš„ <strong>class</strong> å¯¹åº”çš„ dom property å°±æ˜¯ <strong>className</strong></p>
</li>
<li><p>ä¸¤è€…å­˜åœ¨å…³è”ï¼šä¾‹å¦‚ä¸Šè¿°è®¾ç½®äº† HTML attribute çš„ id ä¸ºâ€˜fooâ€™ï¼Œé‚£ä¹ˆå¯¹åº”çš„ DOM properties å½“ä¸­å­˜åœ¨ç›¸åŒå±æ€§åç§°ä¸º id ä¹Ÿä¸º fooï¼Œ<strong>ä¸¤è€…å¯ä»¥å½“ä½œç›´æ¥æ˜ å°„çš„å…³ç³»</strong></p>
</li>
<li><p>å¹¶ä¸æ˜¯éƒ½å­˜åœ¨ç›´æ¥ç›´æ¥æ˜ å°„å…³ç³»ï¼šä¾‹å¦‚ value å±æ€§ï¼Œä¸Šè¿° input è®¾ç½®äº† value å€¼ï¼Œä½†æ˜¯åœ¨ DOM properties å¯¹åº”çš„å€¼ä¸ä»…ä»…æ˜¯ valueï¼Œè¿˜æœ‰ defaultValue å€¼ï¼›å¦‚æœåç»­åœ¨ input æ¡†ä¸­è¾“å…¥äº†å…¶ä»–çš„ value å€¼ bar</p>
<p><img src="/Users/leo/Library/Application%20Support/marktext/images/2022-12-05-00-50-37-image.png" alt></p>
<p>ç„¶åæˆ‘ä»¬å†å»è¯»å–å…¶ç›¸å…³çš„ HTML Attribute å’Œ DOM properties ä¼šå‘ç°</p>
<p><img src="/Users/leo/Library/Application%20Support/marktext/images/2022-12-05-00-53-03-image.png" alt></p>
<p>å…¶å® HTML Attribute åªæ˜¯åšäº†ä¸€ä¸ª<strong>åˆå§‹å€¼çš„èµ‹å€¼</strong>ï¼Œä½†æ˜¯å´æ˜¯å¯¹å…¶ä»–çš„ DOM property ä¹Ÿæœ‰ç›¸å…³å½±å“</p>
</li>
<li><p>éæ³•å±æ€§å€¼ä¼šè¢«æµè§ˆå™¨æ ¡éªŒå¤„ç†æ‰ï¼šä¾‹å¦‚æˆ‘ä»¬åœ¨ <strong>input</strong> çš„ HTML attribute ä¸Šé¢è®¾ç½®äº†ä¸€ä¸ª <strong>type</strong> ç­‰äºä¸€ä¸ªâ€˜fooâ€˜çš„å±æ€§ï¼Œé‚£ä¹ˆä¼šè¢«æµè§ˆå™¨è‡ªåŠ¨å¤„ç†æ‰ã€‚æœ€ç»ˆæˆ‘ä»¬è¯»å– DOM property çš„æ—¶å€™ï¼Œæ˜¯è¢«çŸ«æ­£ä¹‹åçš„å€¼ â€˜<strong>text</strong>â€™</p>
</li>
</ol>
<blockquote>
<p>HTMl Atrribute çš„ä½œç”¨å°±æ˜¯è®¾ç½®ä¸ä¹‹å¯¹åº”çš„ DOM properties çš„åˆå§‹å€¼</p>
</blockquote>
<p>æ‰€ä»¥æŒ‰ç…§ä¸Šè¿°çš„ HTML attribute å’Œ DOM props çš„åŒºåˆ«ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹é€ ç›¸å…³çš„ mountElement çš„æ“ä½œ</p>
<pre><code class="js">/** æŒ‚è½½å‡½æ•°è°ƒç”¨ */
function mountElement(vnode, container) {
  // åˆ›å»ºdomå…ƒç´ 
  const el = createElement(vnode.type);
  console.log(el);
  //å¤„ç†å­èŠ‚ç‚¹, å¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === &quot;string&quot;) {
    // åªéœ€è¦è®¾ç½®å…ƒç´ çš„textContentçš„å±æ€§å³å¯
    setElementText(el, vnode.children);
  } else if (Array.isArray(vnode.children)) {
    // å¦‚æœchildrenæ˜¯æ•°ç»„ï¼Œåˆ™ä¾¿éå†æ¯ä¸€ä¸ªå­—èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨patchçš„æ–¹æ³•
    vnode.children.forEach((child) =&gt; {
      patch(null, child, el);
    });
  }

  // å¤„ç†props, å­˜åœ¨çš„æƒ…å†µä¸‹è¿›è¡Œå¤„ç†
  if (vnode.props) {
    // éå†
    for (const key in vnode.props) {
      const value = vnode.props[key]; // è·å–propså¯¹åº”keyçš„value
      // dom propertieså­˜åœ¨çš„æƒ…å†µ
      if (key in el) {
        el[key] = value;
      } else {
        // è®¾ç½®çš„å±æ€§æ²¡æœ‰å¯¹åº”çš„DOM propertiesçš„æƒ…å†µï¼Œè°ƒç”¨setAttributeå°†å±æ€§è®¾ç½®åˆ°å…ƒç´ ä¸Š
        el.setAttribute(key, value);
      }
    }
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container);
}</code></pre>
<h3 id="æ­£ç¡®çš„è®¾ç½®èŠ‚ç‚¹çš„å±æ€§"><a href="#æ­£ç¡®çš„è®¾ç½®èŠ‚ç‚¹çš„å±æ€§" class="headerlink" title="æ­£ç¡®çš„è®¾ç½®èŠ‚ç‚¹çš„å±æ€§"></a>æ­£ç¡®çš„è®¾ç½®èŠ‚ç‚¹çš„å±æ€§</h3><p><a href>æµè§ˆ</a>å™¨ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬è§£æ HTML æ–‡ä»¶ä¸­çš„ dom å…ƒç´ ï¼Œä»¥åŠç›¸å…³çš„ props çš„å±æ€§è®¾ç½®æ“ä½œã€‚</p>
<p>ä½†æ˜¯åœ¨ vue ä¸­ï¼Œå› ä¸ºç”¨åˆ°äº†è‡ªèº«çš„æ¨¡æ¿æ–‡ä»¶ï¼Œæ‰€ä»¥åœ¨è§£æç›¸å…³çš„èŠ‚ç‚¹çš„æ—¶å€™éœ€è¦è‡ªèº«å¤„ç†è¿™äº›å±æ€§çš„æŒ‚è½½æ“ä½œ</p>
<h4 id="å¸ƒå°”ç±»å‹å±æ€§å¤„ç†"><a href="#å¸ƒå°”ç±»å‹å±æ€§å¤„ç†" class="headerlink" title="å¸ƒå°”ç±»å‹å±æ€§å¤„ç†"></a>å¸ƒå°”ç±»å‹å±æ€§å¤„ç†</h4><p>ä¾‹å¦‚ä¸‹é¢è¿™æ®µ html ä»£ç ï¼š</p>
<pre><code class="html">&lt;button disabled /&gt;</code></pre>
<p>åœ¨æµè§ˆå™¨ä¸­ä¼šå°†å…¶å±æ€§ <strong>disabled</strong> è‡ªåŠ¨çŸ«æ­£ä¸º disabled=true</p>
<p>åœ¨ç›®å‰çš„æˆ‘ä»¬æ¸²æŸ“å™¨ä¸­ï¼Œç±»ä¼¼ä¸ç­‰ä»·äºå¦‚ä¸‹ vnode</p>
<pre><code class="js">const vNode = {
  type: &quot;button&quot;,
  props: {
    disabled: &quot;&quot;,
  },
};</code></pre>
<p>æœ€ç»ˆåœ¨æŒ‚è½½çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è®¾ç½®æ–¹æ³•å°†ç©ºå­—ç¬¦ä¸² è®¾ç½®åˆ° dom å±æ€§ä¸Šé¢ã€‚</p>
<p>ç±»ä¼¼äºï¼š<code>el.disabled=&#39;&#39;</code></p>
<p>ä½†æ˜¯ç”±äºæµè§ˆå™¨çš„è‡ªåŠ¨çŸ«æ­£åŠŸèƒ½ï¼Œä¼šå°†æˆ‘ä»¬çš„ç©ºå­—ç¬¦ä¸²ï¼Œè‡ªåŠ¨çŸ«æ­£ä¸º falseï¼Œè¿™å°±ä¸ç¬¦åˆç”¨æˆ·çš„æœ¬æ„äº†ã€‚</p>
<p>å› æ­¤æˆ‘ä»¬è¦å¯¹è¿™ç§ DOM attribute å¸ƒå°”ç±»å‹çš„å±æ€§ï¼Œåœ¨èµ‹å€¼çš„æ—¶å€™åŠ å…¥ä¸€å±‚åˆ¤æ–­</p>
<pre><code class="js">/** æŒ‚è½½å‡½æ•°è°ƒç”¨ */
function mountElement(vnode, container) {
  // åˆ›å»ºdomå…ƒç´ 
  // ... çœç•¥ä»£ç 

  // å¤„ç†props, å­˜åœ¨çš„æƒ…å†µä¸‹è¿›è¡Œå¤„ç†
  if (vnode.props) {
    // éå†
    for (const key in vnode.props) {
      const value = vnode.props[key]; // è·å–propså¯¹åº”keyçš„value
      // dom propertieså­˜åœ¨çš„æƒ…å†µ
      if (key in el) {
        // è·å–è¿™ä¸ªDOM propertieså…ƒç´ çš„å±æ€§ç±»å‹
        const type = typeof el[key]; // â•
        // å¦‚æœåŸç”Ÿå±æ€§ç±»å‹ä¸ºå¸ƒå°”ç±»å‹ï¼Œå¹¶ä¸”valueæ˜¯ç©ºçš„å­—ç¬¦ä¸²çš„è¯ï¼Œç»™ä»–å€¼çŸ«æ­£ä¸ºtrue
        if (type === &quot;boolean&quot; &amp;&amp; value === &quot;&quot;) {
          // â•
          el[key] = true;
        } else {
          // å…¶ä»–æƒ…å†µ
          el[key] = value;
        }
      } else {
        // è®¾ç½®çš„å±æ€§æ²¡æœ‰å¯¹åº”çš„DOM propertiesçš„æƒ…å†µï¼Œè°ƒç”¨setAttributeå°†å±æ€§è®¾ç½®åˆ°å…ƒç´ ä¸Š
        el.setAttribute(key, value);
      }
    }
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container);
}</code></pre>
<h4 id="åªè¯»ç±»å‹å±æ€§å¤„ç†"><a href="#åªè¯»ç±»å‹å±æ€§å¤„ç†" class="headerlink" title="åªè¯»ç±»å‹å±æ€§å¤„ç†"></a>åªè¯»ç±»å‹å±æ€§å¤„ç†</h4><p>DOM properties å½“ä¸­è¿˜å­˜åœ¨å¾ˆå¤šåªè¯»çš„å±æ€§ï¼Œä¾‹å¦‚ï¼šform</p>
<p>å¦‚ä¸‹ä¾‹å­ï¼š</p>
<pre><code class="html">&lt;form id=&quot;form1&quot;&gt;&lt;/form&gt;
&lt;input form=&quot;form1&quot; /&gt;</code></pre>
<p>ç±»ä¼¼ <code>form</code> è¿™ç§ DOM properties åœ¨æ‰€æœ‰çš„ form æ§ä»¶ä¸Šéƒ½æ˜¯ï¼Œåªè¯»çš„å±æ€§çš„ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡ <code>setAttribute</code>æ¥è®¾ç½®ä»–çš„å±æ€§ï¼Œæ‰€ä»¥è¿™æ—¶å€™è¿˜å¾—è¦ä¿®æ”¹æˆ‘ä»¬çš„é€»è¾‘ï¼Œåˆ¤æ–­å½“å‰çš„å±æ€§åœ¨æµè§ˆå™¨ä¸­æ˜¯å¦æ˜¯åªè¯»çš„ï¼Œå¦‚æœæ˜¯åŒ¹é…ä¸Šè¿™ç§åªè¯»çš„æƒ…å†µçš„å±æ€§ï¼Œä½¿ç”¨<code>setAttribute</code>æ¥è¿›è¡Œèµ‹å€¼</p>
<pre><code class="js">// åˆ¤æ–­æ˜¯å¦åº”è¯¥ä½œä¸ºDOM propertiesçš„è®¾ç½®
function shouldSetAsProps(el, key, value) {
  // å¯¹ç‰¹æ®Šåªè¯»å±æ€§çš„å¤„ç†
  if (key === &quot;form&quot; &amp;&amp; el.tagName === &quot;INPUT&quot;) return false;

  return key in el;
}

/** æŒ‚è½½å‡½æ•°è°ƒç”¨ */
function mountElement(vnode, container) {
  // åˆ›å»ºdomå…ƒç´ 
  // ... çœç•¥ä»£ç 

  // å¤„ç†props, å­˜åœ¨çš„æƒ…å†µä¸‹è¿›è¡Œå¤„ç†
  if (vnode.props) {
    // éå†
    for (const key in vnode.props) {
      const value = vnode.props[key]; // è·å–propså¯¹åº”keyçš„value
      // dom propertieså­˜åœ¨çš„æƒ…å†µ
      if (shouldSetAsProps(el, key, value)) {
        // è·å–è¿™ä¸ªDOM propertieså…ƒç´ çš„å±æ€§ç±»å‹
        const type = typeof el[key];
        // å¦‚æœåŸç”Ÿå±æ€§ç±»å‹ä¸ºå¸ƒå°”ç±»å‹ï¼Œå¹¶ä¸”valueæ˜¯ç©ºçš„å­—ç¬¦ä¸²çš„è¯ï¼Œç»™ä»–å€¼çŸ«æ­£ä¸ºtrue
        if (type === &quot;boolean&quot; &amp;&amp; value === &quot;&quot;) {
          el[key] = true;
        } else {
          el[key] = value;
        }
      } else {
        // è®¾ç½®çš„å±æ€§æ²¡æœ‰å¯¹åº”çš„DOM propertiesçš„æƒ…å†µï¼Œè°ƒç”¨setAttributeå°†å±æ€§è®¾ç½®åˆ°å…ƒç´ ä¸Š
        el.setAttribute(key, value);
      }
    }
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container);
}</code></pre>
<h4 id="æå–å¹³å°æ— å…³ä»£ç "><a href="#æå–å¹³å°æ— å…³ä»£ç " class="headerlink" title="æå–å¹³å°æ— å…³ä»£ç "></a>æå–å¹³å°æ— å…³ä»£ç </h4><p>æˆ‘ä»¬å°†éå† props æ—¶å€™çš„ åˆ¤æ–­è®¾å€¼çš„ä»£ç ï¼Œæå–åˆ° BROWSE_APIS å½“ä¸­ï¼Œä½œä¸ºæµè§ˆå™¨ç«¯çš„æ–¹æ³•ï¼Œå–åä¸º<code>patchProps</code></p>
<pre><code class="js">/** å°†å±æ€§è®¾ç½®ç›¸å…³çš„æ“ä½œå°è£…åˆ°patchPropsçš„å‡½æ•°ä¸­ï¼Œå¹¶ä½œä¸ºæ¸²æŸ“å™¨é€‰é¡¹ä¼ é€’ */
  patchProps(el, key, preValue, nextValue) {
    // åˆ¤æ–­æ˜¯å¦åº”è¯¥ä½œä¸ºDOM propertiesçš„è®¾ç½®
    function shouldSetAsProps(el, key, value) {
      // å¯¹ç‰¹æ®Šåªè¯»å±æ€§çš„å¤„ç†
      if (key === &quot;form&quot; &amp;&amp; el.tagName === &quot;INPUT&quot;) return false;
      // ...è¿˜æœ‰æ›´å¤šç‰¹æ®Šå¤„ç†æƒ…å†µtodo

      return Object.hasOwnProperty.call(vnode.props, key);
    }

    // dom propertieså­˜åœ¨çš„æƒ…å†µ
    if (shouldSetAsProps(el, key, nextValue)) {
      // è·å–è¿™ä¸ªDOM propertieså…ƒç´ çš„å±æ€§ç±»å‹
      const type = typeof el[key];
      // å¦‚æœåŸç”Ÿå±æ€§ç±»å‹ä¸ºå¸ƒå°”ç±»å‹ï¼Œå¹¶ä¸”valueæ˜¯ç©ºçš„å­—ç¬¦ä¸²çš„è¯ï¼Œç»™ä»–å€¼çŸ«æ­£ä¸ºtrue
      if (type === &quot;boolean&quot; &amp;&amp; nextValue === &quot;&quot;) {
        el[key] = true;
      } else {
        el[key] = nextValue;
      }
    } else {
      // è®¾ç½®çš„å±æ€§æ²¡æœ‰å¯¹åº”çš„DOM propertiesçš„æƒ…å†µï¼Œè°ƒç”¨setAttributeå°†å±æ€§è®¾ç½®åˆ°å…ƒç´ ä¸Š
      el.setAttribute(key, nextValue);
    }
  },</code></pre>
<p>æœ€ç»ˆåœ¨ mountElement ä¸­å°±è¿™æ ·è°ƒç”¨</p>
<pre><code class="js">/** æŒ‚è½½å‡½æ•°è°ƒç”¨ */
function mountElement(vnode, container) {
  // åˆ›å»ºdomå…ƒç´ 
  const el = createElement(vnode.type);
  console.log(el);
  //å¤„ç†å­èŠ‚ç‚¹, å¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === &quot;string&quot;) {
    // åªéœ€è¦è®¾ç½®å…ƒç´ çš„textContentçš„å±æ€§å³å¯
    setElementText(el, vnode.children);
  } else if (Array.isArray(vnode.children)) {
    // å¦‚æœchildrenæ˜¯æ•°ç»„ï¼Œåˆ™ä¾¿éå†æ¯ä¸€ä¸ªå­—èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨patchçš„æ–¹æ³•
    vnode.children.forEach((child) =&gt; {
      patch(null, child, el);
    });
  }

  // å¤„ç†props, å­˜åœ¨çš„æƒ…å†µä¸‹è¿›è¡Œå¤„ç†
  if (vnode.props) {
    // éå†
    for (const key in vnode.props) {
      patchProps(el, key, null, vnode.props[key]); // â•
    }
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container);
}</code></pre>
<h3 id="class-å’Œ-style-çš„å¤„ç†"><a href="#class-å’Œ-style-çš„å¤„ç†" class="headerlink" title="class å’Œ style çš„å¤„ç†"></a>class å’Œ style çš„å¤„ç†</h3><p>åœ¨ vue ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ 3 ç§æ–¹å¼å»ä¼ é€’ä¸€ä¸ª class çš„å€¼</p>
<p>å­—ç¬¦ä¸²</p>
<pre><code class="html">&lt;p class=&quot;foo bar&quot;&gt;&lt;/p&gt;</code></pre>
<p>å¯¹è±¡</p>
<pre><code class="html">&lt;p :class=&quot;{ foo:true,  bar:false }&quot;&gt;&lt;/p&gt;</code></pre>
<p>æ•°ç»„</p>
<pre><code class="html">&lt;p :class=&quot;[&#39;foo bar&#39;, {foo:true,  bar:false }]&quot;&gt;&lt;/p&gt;</code></pre>
<p>æ— è®ºæ˜¯ä½•ç§ç»“æ„ï¼Œæˆ‘ä»¬æœ€ç»ˆè½¬åŒ–åˆ° vNode ä¸Šé¢éƒ½æ˜¯è¦æˆä¸ºä¸€ä¸ªå­—ç¬¦ä¸²çš„</p>
<pre><code class="js">const vNode = {
  type: &quot;p&quot;,
  props: {
    class: &quot;foo bar&quot;,
  },
};</code></pre>
<p>å› æ­¤åœ¨ç”Ÿæˆ vnode çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ normalizeClass çš„æ–¹æ³•å»è½¬æ¢ class</p>
<pre><code class="js">const vNode = {
  type: &quot;p&quot;,
  props: {
    class: normalizeClass([
      &quot;foo&quot;,
      {
        foo: false,
        bar: true,
      },
    ]),
  },
};</code></pre>
<h4 id="å®ç°-normalizeClass"><a href="#å®ç°-normalizeClass" class="headerlink" title="å®ç° normalizeClass"></a>å®ç° normalizeClass</h4><p>normalizeClass</p>
<pre><code class="js">/** æ ¼å¼åŒ–class */
function normalizeClass(value) {
  let res = &quot;&quot;;
  if (isString(value)) {
    res = value;
  } else if (isArray(value)) {
    // ç±»ä¼¼æ•°ç»„ join(&#39; &#39;)
    for (let i = 0; i &lt; value.length; i++) {
      const normalized = normalizeClass(value[i]);
      if (normalized) {
        res += normalized + &quot; &quot;;
      }
    }
  } else if (isObject(value)) {
    for (const name in value) {
      if (value[name]) {
        res += name + &quot; &quot;;
      }
    }
  }
  return res.trim();
}</code></pre>
<h4 id="è®¾ç½®-class"><a href="#è®¾ç½®-class" class="headerlink" title="è®¾ç½® class"></a>è®¾ç½® class</h4><p>è®¾ç½® dom class å±æ€§çš„æ–¹å¼æœ‰å¤šç§ï¼Œ<code>setAttribute</code>, <code>el.className</code>, <code>el.classList</code></p>
<p>å…¶ä¸­<code>el.className</code>çš„æ€§èƒ½æœ€å¥½<br>å› æ­¤æˆ‘ä»¬æ”¹ä¹‹æˆ‘ä»¬çš„<code>patchProps</code>æ–¹æ³•</p>
<pre><code class="js">/** å°†å±æ€§è®¾ç½®ç›¸å…³çš„æ“ä½œå°è£…åˆ°patchPropsçš„å‡½æ•°ä¸­ï¼Œå¹¶ä½œä¸ºæ¸²æŸ“å™¨é€‰é¡¹ä¼ é€’ */
  patchProps(el, key, preValue, nextValue) {
    // åˆ¤æ–­æ˜¯å¦åº”è¯¥ä½œä¸ºDOM propertiesçš„è®¾ç½®
    function shouldSetAsProps(el, key, value) {
      // ...
    }

    if (key === &quot;class&quot;) { // â•
      el.className = nextValue || &quot;&quot;;  // â•
    } else if (shouldSetAsProps(el, key, nextValue)) {
      // ...
    } else {
      // ...
    }
  },</code></pre>
<p>å½“ç„¶ style ä¹Ÿæ˜¯ç±»ä¼¼çš„å¤„ç†æ–¹æ¡ˆï¼Œåªä¸è¿‡åœ¨ vue ä¸­è°ƒç”¨çš„æ˜¯<code>normalizeStyle</code>çš„æ–¹æ³•</p>
<h2 id="å¸è½½æ“ä½œ"><a href="#å¸è½½æ“ä½œ" class="headerlink" title="å¸è½½æ“ä½œ"></a>å¸è½½æ“ä½œ</h2><p>ä¸Šè¿°è¯´åˆ°ï¼Œæˆ‘ä»¬åœ¨ render å‡½æ•°ä¸­ä½¿ç”¨äº† <code>container.innerHTML = &#39;&#39;</code>çš„æ–¹å¼å»æ¸…ç©ºå¸è½½;</p>
<pre><code class="js">/** æ¸²æŸ“æ–¹æ³• */
const render = (vnode, container) =&gt; {
  if (vnode) {
    // æ–°çš„nodeå­˜åœ¨çš„æƒ…å†µï¼Œå°†å…¶æ—§çš„vnodeä¸€èµ·ä¼ é€’ç»™patchå‡½æ•°è¿›è¡Œè¡¥ä¸çš„æ›´æ–°
    patch(container._vnode, vnode, container);
  } else {
    if (container._vnode) {
      // æ—§çš„vnodeå­˜åœ¨ï¼Œæ–°çš„vnodeä¸å­˜åœ¨çš„æƒ…å†µï¼Œè¯´æ˜æ˜¯ä¸€ä¸ª unmountï¼ˆå¸è½½ï¼‰çš„æ“ä½œ
      // è¿™é‡Œåªéœ€è¦å°†containerå†…domæ¸…ç©ºå°±å¯ä»¥
      container.innerHTML = &quot;&quot;; // âœ¨
    }
  }
  // æ¯ä¸€æ¬¡éƒ½éœ€è¦ä¿å­˜ä¸Šä¸€æ¬¡çš„vnodeï¼Œå­˜å‚¨åœ¨containerä¸‹
  container._vnode = vnode;
};</code></pre>
<p>è¿™ä¹ˆåšä¸ä¸¥è°¨ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>
<ol>
<li>å®¹å™¨çš„å†…å®¹å¯èƒ½æ˜¯æŸä¸ªç»„ä»¶æˆ–è€…å¤šä¸ªæ¸²æŸ“çš„ï¼Œåœ¨å¸è½½çš„æ—¶å€™åº”è¯¥å»è§¦å‘ç»„ä»¶ç›¸å…³çš„å¸è½½ç”Ÿå‘½å‘¨æœŸå‡½æ•°</li>
<li>è‡ªå®šä¹‰æŒ‡ä»¤ï¼Œæ²¡åŠæ³•æ­£ç¡®æ‰§è¡Œ</li>
<li>dom èº«ä¸Šç»‘å®šçš„ä¸€äº›äº‹ä»¶ï¼Œä¸ä¼šè¿›è¡Œç§»é™¤</li>
</ol>
<p>æ­£ç¡®çš„å¸è½½æ–¹å¼ï¼š</p>
<ol>
<li><p>æ ¹æ® vnode å¯¹è±¡è·å–å…¶å…³è”çš„çœŸå® dom å…ƒç´ </p>
</li>
<li><p>ä½¿ç”¨åŸç”Ÿçš„ dom ç§»é™¤æ“ä½œå°†å…¶ç§»é™¤</p>
</li>
</ol>
<h3 id="å»ºç«‹-dom-ä¸-vnode-è”ç³»"><a href="#å»ºç«‹-dom-ä¸-vnode-è”ç³»" class="headerlink" title="å»ºç«‹ dom ä¸ vnode è”ç³»"></a>å»ºç«‹ dom ä¸ vnode è”ç³»</h3><p>è¦æƒ³æ ¹æ® vnode å¯¹è±¡è·å–å…¶å…³è”çš„çœŸå® dom å…ƒç´ ï¼Œé¦–å…ˆå¿…é¡»è¦å…ˆå»ºç«‹è”ç³»</p>
<p>åœ¨æŒ‚è½½é˜¶æ®µæˆ‘ä»¬åˆ©ç”¨ <code>createElement</code>åˆ›å»ºäº†çœŸå®çš„ domï¼Œä¹‹åå°†å…¶ç»‘å®šåœ¨ vnode ä¸Šï¼Œè¿™æ ·å°±å¯ä»¥å°† vNode å’ŒçœŸå® dom ä¹‹é—´çš„è”ç³»å»ºç«‹èµ·æ¥</p>
<pre><code class="js">/** æŒ‚è½½å‡½æ•°è°ƒç”¨ */
function mountElement(vnode, container) {
  // åˆ›å»ºdomå…ƒç´ 
  const el = createElement(vnode.type);
  console.log(el);
  vnode.el = el; // å°†å…¶åˆ›å»ºå‡ºæ¥çš„domæ·»åŠ åˆ°vnodeä¸Šï¼Œå»ºç«‹è”ç³» â•
  //å¤„ç†å­èŠ‚ç‚¹, å¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === &quot;string&quot;) {
    // ...
  } else if (Array.isArray(vnode.children)) {
    // ...
  }

  // å¤„ç†props, å­˜åœ¨çš„æƒ…å†µä¸‹è¿›è¡Œå¤„ç†
  if (vnode.props) {
    // ...
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container);
}</code></pre>
<h3 id="æ”¹é€ -render-å‡½æ•°"><a href="#æ”¹é€ -render-å‡½æ•°" class="headerlink" title="æ”¹é€  render å‡½æ•°"></a>æ”¹é€  render å‡½æ•°</h3><pre><code class="js">/** æ¸²æŸ“æ–¹æ³• */
const render = (vnode, container) =&gt; {
  if (vnode) {
    // æ–°çš„nodeå­˜åœ¨çš„æƒ…å†µï¼Œå°†å…¶æ—§çš„vnodeä¸€èµ·ä¼ é€’ç»™patchå‡½æ•°è¿›è¡Œè¡¥ä¸çš„æ›´æ–°
    patch(container._vnode, vnode, container);
  } else {
    if (container._vnode) {
      // æ—§çš„vnodeå­˜åœ¨ï¼Œæ–°çš„vnodeä¸å­˜åœ¨çš„æƒ…å†µï¼Œè¯´æ˜æ˜¯ä¸€ä¸ª unmountï¼ˆå¸è½½ï¼‰çš„æ“ä½œ
      // æ ¹æ®vnodeè·å–è¦å¸è½½çš„çœŸå®domå…ƒç´ 
      const el = container._vnode.el; // â•
      // è·å–elçš„çˆ¶çº§å…ƒç´ 
      const parent = el.parentNode; // â•
      // è°ƒç”¨removeChildåˆ é™¤å…ƒç´ 
      if (parent) parent.removeChild(el); // â•
    }
  }
  // æ¯ä¸€æ¬¡éƒ½éœ€è¦ä¿å­˜ä¸Šä¸€æ¬¡çš„vnodeï¼Œå­˜å‚¨åœ¨containerä¸‹
  container._vnode = vnode;
};</code></pre>
<p>å…¶ä¸­çš„ container._vnode ä»£è¡¨çš„å°±æ˜¯æ—§çš„ vnodeï¼ˆå³å°†è¦è¢«å¸è½½çš„ï¼‰ï¼Œç”±äºæˆ‘ä»¬ä¹‹å‰ç»‘å®šä¸Šäº†ç›¸å…³çš„ dom åœ¨ vnode ä¸Šï¼Œå°±å¯ä»¥è°ƒç”¨å…¶çˆ¶çº§çš„ç§»é™¤å…ƒç´ çš„æ“ä½œ</p>
<h3 id="å°è£…-unmount"><a href="#å°è£…-unmount" class="headerlink" title="å°è£… unmount"></a>å°è£… unmount</h3><p>å°†ä¸Šè¿°çš„å¸è½½æ“ä½œå°è£…æˆä¸€ä¸ª unmount çš„å‡½æ•°ï¼Œæ–¹ä¾¿åç»­åŠŸèƒ½å¢åŠ </p>
<p>unmount</p>
<pre><code class="js">/** å¸è½½æ“ä½œ */
function unmount(vnode) {
  // æ ¹æ®vnodeè·å–è¦å¸è½½çš„çœŸå®domå…ƒç´ 
  // è·å–elçš„çˆ¶çº§å…ƒç´ 
  const parent = vnode.el.parentNode;
  if (parent) {
    parent.removeChild(vnode.el);
  }
}</code></pre>
<p>render</p>
<pre><code class="js">const render = (vnode, container) =&gt; {
  if (vnode) {
    // æ–°çš„nodeå­˜åœ¨çš„æƒ…å†µï¼Œå°†å…¶æ—§çš„vnodeä¸€èµ·ä¼ é€’ç»™patchå‡½æ•°è¿›è¡Œè¡¥ä¸çš„æ›´æ–°
    patch(container._vnode, vnode, container);
  } else {
    if (container._vnode) {
      // æ—§çš„vnodeå­˜åœ¨ï¼Œæ–°çš„vnodeä¸å­˜åœ¨çš„æƒ…å†µï¼Œè¯´æ˜æ˜¯ä¸€ä¸ª unmountï¼ˆå¸è½½ï¼‰çš„æ“ä½œ
      unmount(container._vnode); // â•
    }
  }
  // æ¯ä¸€æ¬¡éƒ½éœ€è¦ä¿å­˜ä¸Šä¸€æ¬¡çš„vnodeï¼Œå­˜å‚¨åœ¨containerä¸‹
  container._vnode = vnode;
};</code></pre>
<h2 id="åŒºåˆ†-vnode-ç±»å‹"><a href="#åŒºåˆ†-vnode-ç±»å‹" class="headerlink" title="åŒºåˆ† vnode ç±»å‹"></a>åŒºåˆ† vnode ç±»å‹</h2><p>åœ¨ render å‡½æ•°ä¸­ï¼Œvnode å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œä¼šå°†è€çš„ vnode å’Œæ–°çš„ vnode éƒ½ä¼ é€’ç»™ patch å‡½æ•°å»åšä¸€ä¸ªæ›´æ–°ï¼Œå½“ç„¶æ˜¯æˆ‘ä»¬çš„ node çš„ç±»å‹éƒ½æ˜¯ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ‰æœ‰å»åšæ¯”è¾ƒçš„æ„ä¹‰ã€‚</p>
<p>æ¯”å¦‚ï¼š</p>
<pre><code class="js">const vnode = { type: &quot;p&quot; }; //ç¬¬ä¸€æ¬¡æ¸²æŸ“ï¼š
const vnode = { type: &quot;input&quot; }; // ç¬¬äºŒæ¬¡æ¸²æŸ“</code></pre>
<p>è¿™ç§æƒ…å†µå°±æ²¡æœ‰å¯¹æ¯”æ›´æ–°çš„ä¸€ä¸ªå¿…è¦äº†ã€‚</p>
<p>è¿™ç§æƒ…å†µä¸‹ï¼š</p>
<ol>
<li><p>å…ˆå»å¸è½½ p å…ƒç´ </p>
</li>
<li><p>å†å°† input æŒ‚è½½åˆ°å®¹å™¨ä¸­</p>
</li>
</ol>
<p>å› æ­¤æˆ‘ä»¬éœ€è¦æ”¹é€  patch çš„ä»£ç </p>
<pre><code class="js">/** æ›´æ–°å¯¹æ¯”, å¹¶ä¸”åšæŒ‚è½½ç›¸å…³çš„åŠŸèƒ½ */
function patch(n1, n2, container) {
  // n1è€èŠ‚ç‚¹å­˜åœ¨ï¼Œå¯¹æ¯”n1å’Œn2çš„ç±»å‹
  if (n1 &amp;&amp; n1.type !== n2.type) {
    // â•
    // å¦‚æœæ–°æ—§vnodeçš„ç±»å‹ä¸åŒï¼Œåˆ™ç›´æ¥å°†æ—§çš„vnodeå¸è½½
    unmount(n1); // â•
    n1 = null; // â•
  }
  // å¦‚æœä¸å­˜åœ¨
  if (!n1) {
    mountElement(n2, container);
  } else {
    // n1å­˜åœ¨çš„æƒ…å†µä¸‹é¢ï¼Œæˆ‘ä»¬è¿›è¡Œæ›´æ–°ï¼ˆæ‰“è¡¥ä¸ï¼‰
  }
}</code></pre>
<p>è¿™ç§æƒ…å†µéƒ½æ˜¯ vnode ä¸ºæ™®é€šæ ‡ç­¾å…ƒç´ çš„ç±»å‹æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç¨å¾®æ”¹é€ ä¸€äº›å¯¹ç»„ä»¶ç±»å‹ç­‰ç­‰çš„æ”¯æŒ</p>
<pre><code class="js">/** æ›´æ–°å¯¹æ¯”, å¹¶ä¸”åšæŒ‚è½½ç›¸å…³çš„åŠŸèƒ½ */
function patch(n1, n2, container) {
  // n1è€èŠ‚ç‚¹å­˜åœ¨ï¼Œå¯¹æ¯”n1å’Œn2çš„ç±»å‹
  if (n1 &amp;&amp; n1.type !== n2.type) {
    // å¦‚æœæ–°æ—§vnodeçš„ç±»å‹ä¸åŒï¼Œåˆ™ç›´æ¥å°†æ—§çš„vnodeå¸è½½
    unmount(n1);
    n1 = null;
  }

  const { type } = n2;

  if (typeof type === &quot;string&quot;) {
    // è¯´æ˜æ˜¯æ™®é€šçš„æ ‡ç­¾å…ƒç´ 
    if (!n1) {
      // å¦‚æœä¸å­˜åœ¨, å°±è¿›è¡ŒæŒ‚è½½
      mountElement(n2, container);
    } else {
      // n1å­˜åœ¨çš„æƒ…å†µä¸‹é¢ï¼Œæˆ‘ä»¬è¿›è¡Œæ›´æ–°ï¼ˆæ‰“è¡¥ä¸ï¼‰
      patchElement(n1, n2);
    }
  } else if (typeof type === &quot;object&quot;) {
    // ç»„ä»¶
  } else {
    // å…¶ä»–
  }
}</code></pre>
<h2 id="äº‹ä»¶å¤„ç†"><a href="#äº‹ä»¶å¤„ç†" class="headerlink" title="äº‹ä»¶å¤„ç†"></a>äº‹ä»¶å¤„ç†</h2><p>é¦–å…ˆæˆ‘ä»¬è¦åœ¨ vnode ä¸­å»æè¿°äº‹ä»¶ï¼Œå‡å®šä¸€ä¸ªè§„åˆ™ï¼Œä»¥å­—ç¬¦ä¸² on å¼€å¤´çš„éƒ½è§†ä½œäº‹ä»¶</p>
<pre><code class="js">const vnode = {
  type: &quot;p&quot;,
  props: {
    onClick: () =&gt; {},
  },
  children: &quot;text&quot;,
};</code></pre>
<h3 id="ç»‘å®šäº‹ä»¶å’Œæ›´æ–°"><a href="#ç»‘å®šäº‹ä»¶å’Œæ›´æ–°" class="headerlink" title="ç»‘å®šäº‹ä»¶å’Œæ›´æ–°"></a>ç»‘å®šäº‹ä»¶å’Œæ›´æ–°</h3><p>äº‹ä»¶ç»‘å®šå’Œæ›´æ–°æˆ‘ä»¬å°±éœ€è¦åœ¨ patchProps å‡½æ•°ä¸­åšç›¸å…³çš„å¤„ç†</p>
<pre><code class="js"> /** å°†å±æ€§è®¾ç½®ç›¸å…³çš„æ“ä½œå°è£…åˆ°patchPropsçš„å‡½æ•°ä¸­ï¼Œå¹¶ä½œä¸ºæ¸²æŸ“å™¨é€‰é¡¹ä¼ é€’ */
  patchProps(el, key, preValue, nextValue) {
    // åŒ¹é…äº‹ä»¶ï¼Œä»¥onå¼€å¤´
    if (/^on/.test(key)) { // â•
      // æ ¹æ®å±æ€§åç§°å¾—åˆ°å¯¹åº”çš„äº‹ä»¶åç§°
      const name = key.slice(2).toLowerCase(); // â•
      // ç§»é™¤ä¸Šä¸€æ¬¡ç»‘å®šçš„äº‹ä»¶å¤„ç†å‡½æ•°
      prevValue &amp;&amp; el.removeEventListener(name, prevValue); // â•
      // ç»‘å®šäº‹ä»¶, nextvalueä¸ºäº‹ä»¶å‡½æ•°
      el.addEventListener(name, nextValue); // â•
    } else if (key === &quot;class&quot;) {
      // ...
    } else if (shouldSetAsProps(el, key, nextValue)) {
       // ...
    } else {
      // ...
    }
  }</code></pre>
<p>æŒ‰å¦‚ä¸Šçš„é€»è¾‘ï¼Œå°±æ˜¯ç›¸å½“äºæ¯æ¬¡æ›´æ–°éƒ½è¦å»ç§»é™¤ä¹‹å‰ç»‘å®šçš„å‡½æ•°ï¼Œç„¶åå†å¯¹æ–°çš„å€¼é‡æ–°è¿›è¡Œç›‘å¬ã€‚ä½†æ˜¯è¿™ä¹ˆåšæ€§èƒ½å¹¶ä¸æ˜¯æœ€ä¼˜çš„ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç»‘å®šä¸€ä¸ªä¼ªé€ çš„äº‹ä»¶å¤„ç†å‡½æ•° invokerï¼Œç„¶åæŠŠçœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°è®¾ç½®ä¸º invoker.valueï¼Œåç»­æ›´æ–°å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦æ›´æ–° invoker.value å€¼å°±å¯ä»¥</p>
<pre><code class="js">/** å°†å±æ€§è®¾ç½®ç›¸å…³çš„æ“ä½œå°è£…åˆ°patchPropsçš„å‡½æ•°ä¸­ï¼Œå¹¶ä½œä¸ºæ¸²æŸ“å™¨é€‰é¡¹ä¼ é€’ */
function patchProps(el, key, prevValue, nextValue) {
  // åŒ¹é…äº‹ä»¶ï¼Œä»¥onå¼€å¤´
  if (/^on/.test(key)) {
    // å®šä¹‰el.veiä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå­˜åœ¨äº‹ä»¶åç§°åˆ°äº‹ä»¶å¤„ç†å‡½æ•°çš„æ˜ å°„
    const invokers = el._vei || (el._vei = {});

    // è·å–è¯¥å…ƒç´ ä¼ªé€ çš„äº‹ä»¶å¤„ç†å‡½æ•°, æ ¹æ®key
    let invoker = invokers[key];
    // æ ¹æ®å±æ€§åç§°å¾—åˆ°å¯¹åº”çš„äº‹ä»¶åç§°
    const name = key.slice(2).toLowerCase();

    if (nextValue) {
      if (!invoker) {
        // å¦‚æœæ²¡æœ‰invokerï¼Œä¸ºé¦–æ¬¡ç›‘å¬ï¼Œåˆ™å»ä¼ªé€ ä¸€ä¸ªç¼“å­˜åˆ°el.veiä¸­
        invoker = el._vei[key] = (e) =&gt; {
          // å¦‚æœinvokeræ˜¯æ•°ç»„çš„æƒ…å†µï¼Œéœ€è¦éå†æ‰§è¡Œ
          if (Array.isArray(invoker.value)) {
            invoker.value.forEach((fn) =&gt; fn(e));
          } else {
            // è¿™é‡Œæ‰æ˜¯å¤„ç†çœŸæ­£çš„äº‹ä»¶å‡½æ•°
            invoker.value(e);
          }
        };
        // èµ‹å€¼äº‹ä»¶å¤„ç†å‡½æ•°åˆ°invokerçš„valueä¸Š
        invoker.value = nextValue;
        // ç»‘å®šinvoker
        el.addEventListener(name, invoker);
      } else {
        // å­˜åœ¨invokerè¯´æ˜æ˜¯æ›´æ–°ï¼Œåªéœ€è¦æ›´æ–°invoker.valueå€¼å°±è¡Œ
        invoker.value = nextValue;
      }
    } else if (invoker) {
      // æ–°çš„äº‹ä»¶å‡½æ•°ä¸å­˜åœ¨ï¼Œéœ€è¦é”€æ¯invoker
      el.removeEventListener(name, invoker);
    }
  } else if (key === &quot;class&quot;) {
    // ...
  } else if (shouldSetAsProps(el, key, nextValue)) {
    // ....
  } else {
    // ...
  }
}</code></pre>
<ul>
<li><p>invokersï¼šå­˜äº‹ä»¶åç§°ä¸å¯¹åº”å‡½æ•°çš„æ˜ å°„</p>
</li>
<li><p>el._veiï¼švue event invokerï¼Œåœ¨ el ä¸Šç¼“å­˜ invoker</p>
</li>
</ul>
<h2 id="æ›´æ–°å±æ€§ä»¥åŠå­èŠ‚ç‚¹"><a href="#æ›´æ–°å±æ€§ä»¥åŠå­èŠ‚ç‚¹" class="headerlink" title="æ›´æ–°å±æ€§ä»¥åŠå­èŠ‚ç‚¹"></a>æ›´æ–°å±æ€§ä»¥åŠå­èŠ‚ç‚¹</h2><blockquote>
<p>æ›´æ–°å¿…å®šæ¶‰åŠåˆ°æ•´ä¸ª vnode ä¸Šé¢çš„å±æ€§çš„å˜åŒ–ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹çš„å±æ€§ä»¥åŠèŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„å˜åŒ–</p>
</blockquote>
<p>å…ƒç´ çš„æŒ‚è½½æ˜¯ç”± mountElement è§¦å‘çš„</p>
<pre><code class="js">/** æŒ‚è½½å‡½æ•°è°ƒç”¨ */
function mountElement(vnode, container) {
  // åˆ›å»ºdomå…ƒç´ 
  const el = createElement(vnode.type);
  console.log(el);
  vnode.el = el; // å°†å…¶åˆ›å»ºå‡ºæ¥çš„domæ·»åŠ åˆ°vnodeä¸Šï¼Œå»ºç«‹è”ç³»
  //å¤„ç†å­èŠ‚ç‚¹, å¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === &quot;string&quot;) {
    // åªéœ€è¦è®¾ç½®å…ƒç´ çš„textContentçš„å±æ€§å³å¯
    setElementText(el, vnode.children);
  } else if (Array.isArray(vnode.children)) {
    // å¦‚æœchildrenæ˜¯æ•°ç»„ï¼Œåˆ™ä¾¿éå†æ¯ä¸€ä¸ªå­—èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨patchçš„æ–¹æ³•
    vnode.children.forEach((child) =&gt; {
      patch(null, child, el);
    });
  }

  // å¤„ç†props, å­˜åœ¨çš„æƒ…å†µä¸‹è¿›è¡Œå¤„ç†
  if (vnode.props) {
    // éå†
    for (const key in vnode.props) {
      patchProps(el, key, null, vnode.props[key]);
    }
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container);
}</code></pre>
<p>åœ¨æŒ‚è½½å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œé¦–å…ˆæœ‰ä¸¤ç§çš„ç±»å‹çš„åŒºåˆ†</p>
<ul>
<li><p>å­—ç¬¦ä¸²ï¼šå…·æœ‰æ–‡æœ¬çš„å­èŠ‚ç‚¹</p>
</li>
<li><p>æ•°ç»„ï¼šå¤šä¸ªå­èŠ‚ç‚¹</p>
</li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼Œå­èŠ‚ç‚¹åˆ†ä¸º 3 ç§ç±»å‹ï¼š</p>
<ol>
<li><p>æ²¡æœ‰å­èŠ‚ç‚¹çš„æƒ…å†µ</p>
<pre><code class="js">vnode = {
  type: &quot;div&quot;,
  children: null,
};</code></pre>
</li>
<li><p>å­—ç¬¦ä¸²çš„æƒ…å†µ</p>
<pre><code class="js">vnode = {
  type: &quot;div&quot;,
  children: &quot;222&quot;,
};</code></pre>
</li>
<li><p>æ•°ç»„çš„æƒ…å†µ</p>
<pre><code class="js">vnode = {
  type: &quot;div&quot;,
  children: [&quot;111&quot;, { type: &quot;p&quot; }],
};</code></pre>
</li>
</ol>
<p>å¯¹åº”åˆ°æ›´æ–°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯¹åº”çš„æ–°æ—§èŠ‚ç‚¹éƒ½åˆ†åˆ«æ˜¯ 3 ç§æƒ…å†µ</p>
<img src="file:///Users/leo/Library/Application%20Support/marktext/images/2022-12-09-22-45-02-image.png" title alt width="592">

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å»å®ç° <strong>patchElement</strong>å‡½æ•°</p>
<ul>
<li><p>n1: æ—§ vnode</p>
</li>
<li><p>n2: æ–° vnode</p>
</li>
</ul>
<p><strong>å®ç°æ­¥éª¤</strong></p>
<ol>
<li><p>é¦–å…ˆæˆ‘ä»¬å»æ›´æ–°ä»–ä»¬çš„ <strong>props</strong> çš„å˜åŒ–ï¼Œè°ƒç”¨ä¹‹å‰å°è£…å¥½çš„ <strong>patchProps</strong> å‡½æ•°åšæ›´æ–°å˜åŒ–</p>
</li>
<li><p>ä¹‹åå»æ›´æ–°ä»–ä»¬çš„ <strong>children</strong>ï¼Œè¿™é‡Œè¦å¯¹ä»¥ä¸Š <strong>9</strong> ç§çš„æƒ…å†µè¿›è¡Œè¦†ç›–ã€‚</p>
</li>
</ol>
<h3 id="å®ç°-props-å˜åŒ–æ›´æ–°"><a href="#å®ç°-props-å˜åŒ–æ›´æ–°" class="headerlink" title="å®ç° props å˜åŒ–æ›´æ–°"></a>å®ç° props å˜åŒ–æ›´æ–°</h3><p><strong>å®ç° props çš„æ›´æ–°</strong></p>
<ol>
<li><p>ä»æ–°çš„ props å‚æ•°ä¸­æ‰¾å‡ºæ—§çš„ props ä¸­ä¸ä¹‹å¯¹åº”çš„ key valueï¼Œè°ƒç”¨ pacthProps æ–¹æ³•å¯¹ dom å…ƒç´ è¿›è¡Œå¯¹æ¯”æ›´æ–°</p>
</li>
<li><p>ä»æ—§çš„ props ä¸­æ‰¾å‡ºä¸å­˜åœ¨æ–° props ä¸­çš„å±æ€§ï¼Œè°ƒç”¨ pacthProps çš„æ–¹æ³•è¿›è¡Œ dom å±æ€§çš„å¸è½½</p>
</li>
</ol>
<pre><code class="js">/** æ›´æ–°å­èŠ‚ç‚¹ */
function pacthElement(n1, n2) {
  n2.el = n1.el;
  const el = n2.el;
  const { props: oldProps } = n1;
  const { props: newProps } = n2;
  // step 1 æ›´æ–°props
  for (const key in newProps) {
    if (newProps[key] !== oldProps[key]) {
      patchProps(el, key, oldProps[key], newProps[key]);
    }
  }
  for (const key in oldProps) {
    if (!(key in newProps)) {
      patchProps(el, key, oldProps[key], null);
    }
  }

  // step 2ï¼šæ›´æ–°children
  pacthChildren(n1, n2, el);
}</code></pre>
<h4 id="é¡ºæ‰‹æ”¹é€ -patchProps-å‡½æ•°"><a href="#é¡ºæ‰‹æ”¹é€ -patchProps-å‡½æ•°" class="headerlink" title="é¡ºæ‰‹æ”¹é€  patchProps å‡½æ•°"></a>é¡ºæ‰‹æ”¹é€  patchProps å‡½æ•°</h4><p>æˆ‘ä»¬ä¾æ® patchProps çš„å„ä¸ªåˆ†æ”¯ï¼Œå»ç›¸å¯¹åº”å°è£…æˆ‘ä»¬çš„æ›´æ–°æ–¹æ³•</p>
<p>æœ€ç»ˆçš„æ”¹é€ å¦‚ä¸‹</p>
<pre><code class="js">// æ¯”å¯¹propsåšæ›´æ–°
const patchProp = (el, key, prevValue, nextValue) =&gt; {
  if (key === &quot;class&quot;) {
    // classçš„å¤„ç†
    patchClass(el, nextValue);
  } else if (key === &quot;style&quot;) {
    // styleçš„å¤„ç†
    patchStyle(el, prevValue, nextValue);
  } else if (/^on[^a-z]/.test(key)) {
    // äº‹ä»¶çš„å¤„ç†
    patchEvent(el, key, nextValue);
  } else {
    // å…¶ä»–å±æ€§çš„å¤„ç†
    patchAttr(el, key, nextValue);
  }
};</code></pre>
<h5 id="æ“ä½œ-class-æ›´æ–°"><a href="#æ“ä½œ-class-æ›´æ–°" class="headerlink" title="æ“ä½œ class æ›´æ–°"></a>æ“ä½œ class æ›´æ–°</h5><pre><code class="js">/** æ¯”å¯¹classå±æ€§ */
function patchClass(el, value) {
  // æ ¹æ®æœ€æ–°å€¼è®¾ç½®ç±»å
  if (value == null) {
    el.removeAttribute(&quot;class&quot;);
  } else {
    el.className = value;
  }
}</code></pre>
<h5 id="æ“ä½œæ ·å¼çš„æ›´æ–°"><a href="#æ“ä½œæ ·å¼çš„æ›´æ–°" class="headerlink" title="æ“ä½œæ ·å¼çš„æ›´æ–°"></a>æ“ä½œæ ·å¼çš„æ›´æ–°</h5><pre><code class="js">/** æ¯”å¯¹classå±æ€§ */
function patchStyle(el, prev, next) {
  // æ›´æ–°style
  const style = el.style;
  for (const key in next) {
    // ç”¨æœ€æ–°çš„ç›´æ¥è¦†ç›–
    style[key] = next[key];
  }
  if (prev) {
    for (const key in prev) {
      // è€çš„æœ‰æ–°çš„æ²¡æœ‰åˆ é™¤
      if (next[key] == null) {
        style[key] = null;
      }
    }
  }
}</code></pre>
<h5 id="æ“ä½œäº‹ä»¶çš„æ›´æ–°"><a href="#æ“ä½œäº‹ä»¶çš„æ›´æ–°" class="headerlink" title="æ“ä½œäº‹ä»¶çš„æ›´æ–°"></a>æ“ä½œäº‹ä»¶çš„æ›´æ–°</h5><pre><code class="js">/** åˆ›å»ºä¸€ä¸ªinvoker */
function createInvoker(initialValue) {
  const invoker = (e) =&gt; invoker.value(e);
  invoker.value = initialValue;
  return invoker;
}
/** æ¯”å¯¹äº‹ä»¶æ›´æ–° */
function patchEvent(el, rawName, nextValue) {
  // æ›´æ–°äº‹ä»¶
  const invokers = el._vei || (el._vei = {});
  const exisitingInvoker = invokers[rawName]; // æ˜¯å¦ç¼“å­˜è¿‡

  if (nextValue &amp;&amp; exisitingInvoker) {
    exisitingInvoker.value = nextValue;
  } else {
    const name = rawName.slice(2).toLowerCase(); // è½¬åŒ–äº‹ä»¶æ˜¯å°å†™çš„
    if (nextValue) {
      // ç¼“å­˜å‡½æ•°
      const invoker = (invokers[rawName] = createInvoker(nextValue));
      el.addEventListener(name, invoker);
    } else if (exisitingInvoker) {
      el.removeEventListener(name, exisitingInvoker);
      invokers[rawName] = undefined;
    }
  }
}</code></pre>
<h5 id="æ“ä½œå±æ€§çš„æ›´æ–°"><a href="#æ“ä½œå±æ€§çš„æ›´æ–°" class="headerlink" title="æ“ä½œå±æ€§çš„æ›´æ–°"></a>æ“ä½œå±æ€§çš„æ›´æ–°</h5><pre><code class="js">/** æ¯”å¯¹dom propertiesæˆ–è€…æ˜¯html attributes */
function patchAttr(el, key, value) {
    // æ›´æ–°å±æ€§
    if (value == null) {
      // å¦‚æœå€¼ä¸å­˜åœ¨ï¼Œè¯´æ˜æ˜¯å¸è½½propsçš„æ“ä½œ
      el.removeAttribute(key);
    } else {
      if (shouldSetAsProps(el, key, nextValue)) {
        // dom propertieså­˜åœ¨çš„æƒ…å†µ
        // è·å–è¿™ä¸ªDOM propertieså…ƒç´ çš„å±æ€§ç±»å‹
        const type = typeof el[key];
        // å¦‚æœåŸç”Ÿå±æ€§ç±»å‹ä¸ºå¸ƒå°”ç±»å‹ï¼Œå¹¶ä¸”valueæ˜¯ç©ºçš„å­—ç¬¦ä¸²çš„è¯ï¼Œç»™ä»–å€¼çŸ«æ­£ä¸ºtrue
        if (type === &quot;boolean&quot; &amp;&amp; nextValue === &quot;&quot;) {
          el[key] = true;
        } else {
          el[key] = nextValue;
        }
      } else {
        el.setAttribute(key, value);
      }
    }
  }</code></pre>
<h3 id="æ›´æ–°-children-èŠ‚ç‚¹"><a href="#æ›´æ–°-children-èŠ‚ç‚¹" class="headerlink" title="æ›´æ–° children èŠ‚ç‚¹"></a>æ›´æ–° children èŠ‚ç‚¹</h3><p>å¯¹ç…§ä»¥ä¸Š 3*3 çš„èŠ‚ç‚¹æƒ…å†µ</p>
<h4 id="1-æ–°å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹"><a href="#1-æ–°å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹" class="headerlink" title="1. æ–°å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹"></a>1. æ–°å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹</h4><pre><code class="js">/** æ›´æ–°children */
function pacthChildren(n1, n2, container) {
  // åˆ¤æ–­æ–°å­èŠ‚ç‚¹çš„ç±»å‹æ˜¯å¦æ˜¯æ–‡æœ¬èŠ‚ç‚¹
  if (typeof n2.children === &quot;string&quot;) {
    // å½“æ–°èŠ‚ç‚¹ä¸ºæ–‡æœ¬èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¦‚æœæ—§èŠ‚ç‚¹æ˜¯ä¸€ç»„å­çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦é€ä¸ªå»å¸è½½ï¼Œå…¶ä»–æƒ…å†µå•¥ä¹Ÿä¸åš
    if (Array.isArray(n1.children)) {
      n1.children.forEach((node) =&gt; unmount(node));
    }
    // æœ€åè®¾ç½®æ–°çš„èŠ‚ç‚¹å†…å®¹
    setElementText(container, n2.children);
  }
}</code></pre>
<h4 id="2-æ–°å­èŠ‚ç‚¹æ˜¯ä¸€ç»„"><a href="#2-æ–°å­èŠ‚ç‚¹æ˜¯ä¸€ç»„" class="headerlink" title="2. æ–°å­èŠ‚ç‚¹æ˜¯ä¸€ç»„"></a>2. æ–°å­èŠ‚ç‚¹æ˜¯ä¸€ç»„</h4><pre><code class="js">/** æ›´æ–°children */
function pacthChildren(n1, n2, container) {
  // åˆ¤æ–­æ–°å­èŠ‚ç‚¹çš„ç±»å‹æ˜¯å¦æ˜¯æ–‡æœ¬èŠ‚ç‚¹
  if (typeof n2.children === &quot;string&quot;) {
    // ...
  } else if (Array.isArray(n2.children)) {
    // å½“æ–°çš„å­èŠ‚ç‚¹æ˜¯ä¸€ç»„
    // æˆ‘ä»¬åˆ¤æ–­æ—§çš„å­èŠ‚ç‚¹æ˜¯å¦ä¹Ÿæ˜¯ä¸€ç»„
    if (Array.isArray(n1.children)) {
      // diffç®—æ³• todo
    } else {
      // åˆ°è¿™é‡Œï¼Œå­˜åœ¨ä¸¤ç§æƒ…å†µï¼Œè¦ä¹ˆæ˜¯æ–‡æœ¬èŠ‚ç‚¹è¦ä¹ˆæ— 
      // ä»€ä¹ˆæƒ…å†µä¸‹éƒ½å»æ¸…ç©ºï¼Œç„¶åå°†ä¸€ç»„æ–°çš„å­èŠ‚ç‚¹æ·»åŠ è¿›æ¥
      setElementText(container, &quot;&quot;);
      n2.children.forEach((node) =&gt; patch(null, node, container));
    }
  }
}</code></pre>
<p>diff ç®—æ³•ï¼Œç›®å‰å…ˆç”¨å‚»ç“œé€»è¾‘å®ç°ï¼Œå…¨éƒ¨å¸è½½ç„¶åå†å…¨éƒ¨æŒ‚è½½</p>
<pre><code class="js">n1.children.forEach((node) =&gt; unmount(node));
n2.children.forEach((node) =&gt; patch(null, node, container));</code></pre>
<h4 id="3-æ–°å­èŠ‚ç‚¹å•¥ä¹Ÿæ²¡æœ‰"><a href="#3-æ–°å­èŠ‚ç‚¹å•¥ä¹Ÿæ²¡æœ‰" class="headerlink" title="3. æ–°å­èŠ‚ç‚¹å•¥ä¹Ÿæ²¡æœ‰"></a>3. æ–°å­èŠ‚ç‚¹å•¥ä¹Ÿæ²¡æœ‰</h4><pre><code class="js">/** æ›´æ–°children */
function pacthChildren(n1, n2, container) {
  // åˆ¤æ–­æ–°å­èŠ‚ç‚¹çš„ç±»å‹æ˜¯å¦æ˜¯æ–‡æœ¬èŠ‚ç‚¹
  if (typeof n2.children === &quot;string&quot;) {
    // å½“æ–°èŠ‚ç‚¹ä¸ºæ–‡æœ¬èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¦‚æœæ—§èŠ‚ç‚¹æ˜¯ä¸€ç»„å­çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦é€ä¸ªå»å¸è½½ï¼Œå…¶ä»–æƒ…å†µå•¥ä¹Ÿä¸åš
    if (Array.isArray(n1.children)) {
      n1.children.forEach((node) =&gt; unmount(node));
    }
    // æœ€åè®¾ç½®æ–°çš„èŠ‚ç‚¹å†…å®¹
    setElementText(container, n2.children);
  } else if (Array.isArray(n2.children)) {
    // ....
  } else {
    // åˆ°è¿™é‡Œï¼Œè¯´æ˜æ–°çš„å­èŠ‚ç‚¹ä¸å­˜åœ¨
    // å¦‚æœæ—§çš„èŠ‚ç‚¹æ˜¯ä¸€ç»„å­èŠ‚ç‚¹ï¼Œåªéœ€è¦é€ä¸ªå¸è½½å°±å¯ä»¥
    if (Array.isArray(n1.children)) {
      n1.children.forEach((node) =&gt; unmount(node));
    } else if (typeof n1.children === &quot;string&quot;) {
      // æ—§èŠ‚ç‚¹æ˜¯æ–‡æœ¬ï¼Œæ¸…ç©º
      setElementText(container, &quot;&quot;);
    }
    // å…¶ä»–æƒ…å†µä¸ç”¨ç®¡
  }
}</code></pre>
<h2 id="ç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹"><a href="#ç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹" class="headerlink" title="ç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹"></a>ç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹</h2><p>ä¸€èˆ¬æˆ‘ä»¬ç”¨ vnode æè¿°èŠ‚ç‚¹ï¼Œéƒ½æ˜¯ç”¨ type å»æè¿°èŠ‚ç‚¹ç±»å‹</p>
<p>ä½†æ˜¯ åƒ æ–‡æœ¬èŠ‚ç‚¹ æ³¨é‡ŠèŠ‚ç‚¹ ä»¥åŠ vue3 çš„ fragmentï¼Œéƒ½è¾ƒä¸ºç‰¹æ®Š</p>
<pre><code class="html">&lt;Fragment&gt;
  &lt;!-- æ³¨é‡ŠèŠ‚ç‚¹ --&gt;
  æ–‡æœ¬èŠ‚ç‚¹
&lt;/Fragment&gt;</code></pre>
<h3 id="æ–‡æœ¬èŠ‚ç‚¹å’Œæ³¨é‡ŠèŠ‚ç‚¹å¤„ç†"><a href="#æ–‡æœ¬èŠ‚ç‚¹å’Œæ³¨é‡ŠèŠ‚ç‚¹å¤„ç†" class="headerlink" title="æ–‡æœ¬èŠ‚ç‚¹å’Œæ³¨é‡ŠèŠ‚ç‚¹å¤„ç†"></a>æ–‡æœ¬èŠ‚ç‚¹å’Œæ³¨é‡ŠèŠ‚ç‚¹å¤„ç†</h3><p>è¿™ä¸¤è€…å¯¹äºæ™®é€šæ ‡ç­¾èŠ‚ç‚¹æ¥è¯´ï¼Œä¸å…·å¤‡æ ‡ç­¾åç§°ï¼Œæ‰€ä»¥éœ€è¦æ¡†æ¶è®¤ä¸ºçš„å»åˆ›é€ ä¸€äº›å”¯ä¸€çš„æ ‡è¯†ï¼Œå¹¶ä¸”å°†å…¶ä½œä¸ºæ³¨é‡ŠèŠ‚ç‚¹å’Œæ–‡æœ¬èŠ‚ç‚¹çš„ type</p>
<p>æè¿°æ–‡æœ¬å’Œæ³¨é‡ŠèŠ‚ç‚¹ï¼š</p>
<pre><code class="js">// åŠ å…¥äººä¸ºçš„æ–‡æœ¬èŠ‚ç‚¹æ ‡è¯†
const Text = Symbol();
const newVnode = {
  type: Text,
  children: &quot;æ–‡æœ¬èŠ‚ç‚¹&quot;,
};
// åŠ å…¥äººä¸ºçš„æ³¨é‡ŠèŠ‚ç‚¹æ ‡è¯†
const Comment = Symbol();
const newVnode = {
  type: Comment,
  children: &quot;æ³¨é‡Šçš„èŠ‚ç‚¹&quot;,
};</code></pre>
<p>åŠ å…¥ä¸¤è€…ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åœ¨ patch ä¸­å»åšç›¸å…³çš„æ”¹é€ </p>
<pre><code class="js">/** æ›´æ–°å¯¹æ¯”, å¹¶ä¸”åšæŒ‚è½½ç›¸å…³çš„åŠŸèƒ½ */
  function patch(n1, n2, container) {
    // n1è€èŠ‚ç‚¹å­˜åœ¨ï¼Œå¯¹æ¯”n1å’Œn2çš„ç±»å‹
    if (n1 &amp;&amp; n1.type !== n2.type) {
      // å¦‚æœæ–°æ—§vnodeçš„ç±»å‹ä¸åŒï¼Œåˆ™ç›´æ¥å°†æ—§çš„vnodeå¸è½½
      unmount(n1);
      n1 = null;
    }

    const { type } = n2;

    if (typeof type === &quot;string&quot;) {
      // ....
    } else if (typeof type === &quot;object&quot;) {
      // ç»„ä»¶
    } else if (type === Text) {
      // æ–‡æœ¬æ ‡ç­¾
      if (!n1) {
        // ä½¿ç”¨åŸç”ŸcreateTextNodeå»åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹
        const el = (n2.el = document.createTextNode(n2.children));
        // å°†æ–‡æœ¬èŠ‚ç‚¹æ’å…¥åˆ°å®¹å™¨ä¸­
        insert(el, container);
      } else {
        // å¦‚æœæ—§çš„vnodeå­˜åœ¨ï¼Œåªéœ€è¦ä½¿ç”¨å¿ƒå¾—æ–‡æœ¬èŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹æ›´æ–°æ—§æ–‡æœ¬èŠ‚ç‚¹å°±å¯ä»¥äº†
        const el = (n2.el = n1.el);
        if (n2.children !== n1.children) {
          el.nodeValue = n2.children;
        }
      }
    }</code></pre>
<p>å½“ç„¶ä¸Šè¿°ç”¨åˆ°äº†ç›¸å…³æµè§ˆå™¨çš„ api æˆ‘ä»¬éœ€è¦ç»™ä»–æå–å‡ºæ¥<code>document.createTextNode</code>ä»¥åŠ<code>el.nodeValue</code></p>
<pre><code class="js">/** æµè§ˆå™¨ç«¯çš„ç›¸å…³api */
const BROWSER_APIS = {
  // ç”¨äºåˆ›å»ºå…ƒç´ 
  createElement(tag) {
    // ...
  },

  /** ç”¨äºè®¾ç½®å…ƒç´ çš„æ–‡æœ¬èŠ‚ç‚¹ */
  setElementText(el, text) {
    // ...
  },

  /** ç»™ç‰¹å®šçš„parentä¸‹æ·»åŠ æŒ‡å®šçš„å…ƒç´  */
  insert(el, parent, anchor = null) {
    // ...
  },

  /** åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹ */
  createText(text) {
    // â•
    return document.createTextNode(text);
  },

  /** è®¾ç½®æ–‡æœ¬å€¼ */
  setText(el, text) {
    // â•
    el.nodeValue = text;
  },

  /** å°†å±æ€§è®¾ç½®ç›¸å…³çš„æ“ä½œå°è£…åˆ°patchPropsçš„å‡½æ•°ä¸­ï¼Œå¹¶ä½œä¸ºæ¸²æŸ“å™¨é€‰é¡¹ä¼ é€’ */
  patchProps(el, key, prevValue, nextValue) {
    // ...
  },
};</code></pre>
<p>å¤„ç†æ³¨é‡Šçš„èŠ‚ç‚¹å’Œå…¶ç±»ä¼¼ï¼Œè°ƒç”¨åŸç”Ÿçš„ <code>document.createComment</code>å‡½æ•°æ¥åˆ›å»ºå³å¯</p>
<h3 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h3><p>Fragment å’Œ tex ä»¥åŠæ³¨é‡Šç±»ä¼¼ï¼Œtype ä¹Ÿéœ€è¦äººä¸ºåŠ å…¥æ ‡è¯†</p>
<pre><code class="js">const Fragment = Symbol();</code></pre>
<p>åœ¨é¡¹ç›®ä¸­ç»å¸¸ä¼šæœ‰ç±»ä¼¼è¿™æ ·çš„ vNodeï¼Œ</p>
<pre><code class="js">const vNode = {
  type: &quot;ul&quot;,
  children: [
    {
      type: Fragment,
      children: [
        {
          type: &quot;li&quot;,
          children: &quot;1&quot;,
        },
        {
          type: &quot;li&quot;,
          children: &quot;2&quot;,
        },
      ],
    },
  ],
};</code></pre>
<p>ç”±äº Fragment æœ¬èº«æ˜¯ä¸å±äºä¸€ä¸ªçœŸæ­£çš„èŠ‚ç‚¹çš„ï¼Œæ‰€ä»¥åœ¨åšæ¸²æŸ“çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦æ¸²æŸ“å®ƒçš„å­èŠ‚ç‚¹å°±å¯ä»¥äº†</p>
<p>å› æ­¤æˆ‘ä»¬æ”¹é€  patch å‡½æ•°</p>
<pre><code class="js">/** æ›´æ–°å¯¹æ¯”, å¹¶ä¸”åšæŒ‚è½½ç›¸å…³çš„åŠŸèƒ½ */
function patch(n1, n2, container) {
  // n1è€èŠ‚ç‚¹å­˜åœ¨ï¼Œå¯¹æ¯”n1å’Œn2çš„ç±»å‹
  if (n1 &amp;&amp; n1.type !== n2.type) {
    // å¦‚æœæ–°æ—§vnodeçš„ç±»å‹ä¸åŒï¼Œåˆ™ç›´æ¥å°†æ—§çš„vnodeå¸è½½
    unmount(n1);
    n1 = null;
  }

  const { type } = n2;

  if (typeof type === &quot;string&quot;) {
    // ...
  } else if (typeof type === &quot;object&quot;) {
    // ç»„ä»¶
  } else if (type === Text) {
    // ...
  } else if (type === Fragment) {
    // å¦‚æœæ˜¯ ç‰‡æ®µèŠ‚ç‚¹
    if (!n1) {
      // å¦‚æœä¸å­˜åœ¨æ—§èŠ‚ç‚¹çš„è¯ï¼Œåªéœ€è¦å°†Fragmentçš„childrené€ä¸ªæŒ‚è½½å°±å¯ä»¥
      n2.children.forEach((node) =&gt; patch(null, node, container));
    } else {
      // å¦‚æœæ—§çš„vnodeå­˜åœ¨çš„è¯ï¼Œ åˆ™åªéœ€è¦æ›´æ–°fragmentçš„childrenå°±å¯ä»¥
      pacthChildren(n1, n2, container);
    }
  }
}</code></pre>
<p>å¹¶ä¸”å¯¹äºæˆ‘ä»¬åœ¨å¸è½½çš„æ—¶å€™ï¼Œä¹Ÿè¦åšç›¸å…³çš„å¤„ç†</p>
<pre><code class="js">/** å¸è½½æ“ä½œ */
function unmount(vnode) {
  // åœ¨å¸è½½çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯å¸è½½çš„vnodeç±»å‹ä¸ºFragmentï¼Œ åˆ™éœ€è¦å¸è½½ä»–çš„children
  if (vnode.type === Fragment) {
    vnode.children.forEach((node) =&gt; unmount(node));
    return;
  }
  // æ ¹æ®vnodeè·å–è¦å¸è½½çš„çœŸå®domå…ƒç´ 
  // è·å–elçš„çˆ¶çº§å…ƒç´ 
  const parent = vnode.el.parentNode;
  if (parent) {
    parent.removeChild(vnode.el);
  }
}</code></pre>
<blockquote>
<p>åé¢å†è¯´ diff</p>
</blockquote>
<h2 id="diff-ç®—æ³•"><a href="#diff-ç®—æ³•" class="headerlink" title="diff ç®—æ³•"></a>diff ç®—æ³•</h2><p>// todoâ€¦.</p>
<h3 id="ç®€å•çš„-diff-ç®—æ³•"><a href="#ç®€å•çš„-diff-ç®—æ³•" class="headerlink" title="ç®€å•çš„ diff ç®—æ³•"></a>ç®€å•çš„ diff ç®—æ³•</h3><h3 id="åŒç«¯-diff-ç®—æ³•"><a href="#åŒç«¯-diff-ç®—æ³•" class="headerlink" title="åŒç«¯ diff ç®—æ³•"></a>åŒç«¯ diff ç®—æ³•</h3><h3 id="å¿«é€Ÿ-diff-ç®—æ³•"><a href="#å¿«é€Ÿ-diff-ç®—æ³•" class="headerlink" title="å¿«é€Ÿ diff ç®—æ³•"></a>å¿«é€Ÿ diff ç®—æ³•</h3>
        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    æœ€åæ›´æ–°æ—¶é—´ï¼š<time datetime="2022-12-13T01:41:56.270Z" itemprop="dateUpdated">2022-12-13 09:41:56</time>
</span><br>


        
        Happy Coding
        
    </div>
    
    <footer>
        <a href="https://github.com/NollieLeo">
            <img src="/img/avatar.png" alt="Mr.Weng">
            Mr.Weng
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">èµ</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/diff/" rel="tag">diff</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vue/" rel="tag">vue</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://github.com/NollieLeo/2022/12/03/vue3%E6%B8%B2%E6%9F%93%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%BB%E7%BB%93/&title=ã€Švue3æ¸²æŸ“å™¨è®¾è®¡ä¸æ€»ç»“ã€‹ â€” ç¿è€å¸ˆçš„åšå®¢&pic=https://github.com/NollieLeo/img/avatar.png" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://github.com/NollieLeo/2022/12/03/vue3%E6%B8%B2%E6%9F%93%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%BB%E7%BB%93/&title=ã€Švue3æ¸²æŸ“å™¨è®¾è®¡ä¸æ€»ç»“ã€‹ â€” ç¿è€å¸ˆçš„åšå®¢&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://github.com/NollieLeo/2022/12/03/vue3%E6%B8%B2%E6%9F%93%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%BB%E7%BB%93/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Švue3æ¸²æŸ“å™¨è®¾è®¡ä¸æ€»ç»“ã€‹ â€” ç¿è€å¸ˆçš„åšå®¢&url=https://github.com/NollieLeo/2022/12/03/vue3%E6%B8%B2%E6%9F%93%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%BB%E7%BB%93/&via=https://github.com/NollieLeo" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://github.com/NollieLeo/2022/12/03/vue3%E6%B8%B2%E6%9F%93%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%BB%E7%BB%93/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2023/01/28/diff%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86%E5%92%8C%E6%80%BB%E7%BB%93/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">diffç®—æ³•åŸç†å’Œæ€»ç»“</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2022/11/09/%E5%8F%8C%E5%87%BB%E4%BA%8B%E4%BB%B6%E5%92%8C%E5%8D%95%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%86%B2%E7%AA%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">åŒå‡»äº‹ä»¶å’Œå•æœºäº‹ä»¶å†²çªè§£å†³æ–¹æ¡ˆ</h4>
      </a>
    </div>
  
</nav>



    




















</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        è°¢è°¢å¤§çˆ·~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/false" alt="æ‰“èµäºŒç»´ç ">
        </div>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        ç«™ç‚¹æ€»è®¿å®¢æ•°ï¼š<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        ç«™ç‚¹æ€»è®¿é—®é‡ï¼š<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>åšå®¢å†…å®¹éµå¾ª <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Mr.Weng &copy; 2020 - 2023</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://github.com/NollieLeo/2022/12/03/vue3%E6%B8%B2%E6%9F%93%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%BB%E7%BB%93/&title=ã€Švue3æ¸²æŸ“å™¨è®¾è®¡ä¸æ€»ç»“ã€‹ â€” ç¿è€å¸ˆçš„åšå®¢&pic=https://github.com/NollieLeo/img/avatar.png" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://github.com/NollieLeo/2022/12/03/vue3%E6%B8%B2%E6%9F%93%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%BB%E7%BB%93/&title=ã€Švue3æ¸²æŸ“å™¨è®¾è®¡ä¸æ€»ç»“ã€‹ â€” ç¿è€å¸ˆçš„åšå®¢&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://github.com/NollieLeo/2022/12/03/vue3%E6%B8%B2%E6%9F%93%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%BB%E7%BB%93/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€Švue3æ¸²æŸ“å™¨è®¾è®¡ä¸æ€»ç»“ã€‹ â€” ç¿è€å¸ˆçš„åšå®¢&url=https://github.com/NollieLeo/2022/12/03/vue3%E6%B8%B2%E6%9F%93%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%BB%E7%BB%93/&via=https://github.com/NollieLeo" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://github.com/NollieLeo/2022/12/03/vue3%E6%B8%B2%E6%9F%93%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%BB%E7%BB%93/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://github.com/NollieLeo/2022/12/03/vue3%E6%B8%B2%E6%9F%93%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%BB%E7%BB%93/" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'æˆ‘èµ°äº†';
            clearTimeout(titleTime);
        } else {
            document.title = 'æˆ‘æ¥äº†';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
